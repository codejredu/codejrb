
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בלוקלי: פריסה בסגנון סקראץ' - מודולרי</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/blockly@9.0.0/blockly.min.js"></script>
    <style>
        /* Embedded CSS - in real project this would be in external file */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            padding-top: 56px;
        }
        .container-wrapper {
            position: relative;
            display: flex;
            flex-direction: row-reverse;
            justify-content: center;
            align-items: flex-start;
            gap: 1.5rem;
            width: 100%;
            padding: 2rem;
            box-sizing: border-box;
            transition: all 0.3s ease-in-out;
        }
        .left-panel {
            display: flex;
            flex-direction: column;
            width: 35%;
            flex-shrink: 0;
            gap: 1.5rem;
            transition: all 0.3s ease-in-out;
            max-height: calc(100vh - 56px - 4rem);
            overflow-y: auto;
            padding-left: 8px;
        }
        .right-panel {
            display: flex;
            flex-direction: column;
            width: 65%;
            gap: 1.5rem;
            transition: all 0.3s ease-in-out;
        }
        .section {
            background-color: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #ccc;
            position: relative;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .section-header h2 {
            font-size: 1.25rem;
            font-weight: bold;
        }
        #stage-aspect-ratio-wrapper {
            position: relative;
            width: 100%;
            padding-top: 75%;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: white;
            border: 2px solid #ccc;
            transition: all 0.3s ease-in-out;
            flex-shrink: 0;
        }
        #stage-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            border-radius: 12px;
        }
        .sprite-container {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 1px;
            height: 1px;
            visibility: hidden;
        }
        .sprite-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 80px;
            height: 80px;
            background-color: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            transform-origin: center center;
            z-index: 10;
            opacity: 1;
            cursor: grab;
            visibility: visible;
            transform: translate(-50%, -50%);
        }
        .sprite-wrapper:active {
            cursor: grabbing;
        }
        .sprite-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .speech-bubble {
            position: absolute;
            background: #fdfd96;
            border-radius: 12px;
            padding: 8px 12px;
            border: 1px solid #ccc;
            white-space: nowrap;
            font-size: 0.9rem;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 11;
        }
        .speech-bubble::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 100%;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-top-color: #fdfd96;
            border-bottom: 0;
            margin-left: -8px;
            margin-top: -1px;
        }
        .speech-bubble.visible {
            opacity: 1;
        }
        .sprite-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border: 2px solid #e5e7eb;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-radius: 12px;
            padding: 0.5rem;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
            position: relative;
            flex-shrink: 0;
        }
        .sprite-card.selected {
            border-color: #4C97FF;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .sprite-card img {
            width: 48px;
            height: 48px;
            object-fit: contain;
            border-radius: 8px;
        }
        .delete-button {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            cursor: pointer;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .sprite-card:hover .delete-button {
            visibility: visible;
            opacity: 1;
        }
        .backdrop-card {
            width: 80px;
            height: 60px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            transition: border-color 0.2s;
            flex-shrink: 0;
        }
        .backdrop-card.selected {
            border-color: #4C97FF;
        }
        .plus-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #4C97FF;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .gallery-container {
            width: 100%;
            padding: 1rem;
            background-color: #f0f4f8;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: none;
            transition: all 0.5s ease-in-out;
            border: 2px solid #ccc;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 20;
            height: 100%;
            overflow-y: auto;
        }
        .gallery-container.visible {
            display: block;
        }
        .thumbnail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 0.5rem;
        }
        .thumbnail {
            width: 100%;
            height: auto;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .close-gallery-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: #ccc;
            color: #333;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- Project Controls Bar -->
    <div id="project-controls" class="w-full bg-white shadow-md p-2 flex justify-start items-center gap-4 fixed top-0 left-0 z-50" dir="rtl">
        <button id="save-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors">
            <span>שמור פרויקט</span>
        </button>
        <button id="load-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2 transition-colors">
            <span>טען פרויקט</span>
        </button>
        <input type="file" id="load-input" class="hidden" accept=".kidi, .json">
    </div>

    <!-- Main Container -->
    <div id="container-wrapper" class="container-wrapper">
        <!-- Left Panel -->
        <div class="left-panel">
            <!-- Stage Section -->
            <div id="stage-header">
                <h2 class="panel-title text-xl font-bold">במה</h2>
                <div id="stage-controls">
                    <button id="run-button" class="w-10 h-10 bg-green-500 text-white font-bold rounded-full flex justify-center items-center shadow-md hover:bg-green-600 transition-colors" title="הפעל">▶</button>
                    <button id="reset-button" class="w-10 h-10 bg-red-500 text-white font-bold rounded-full flex justify-center items-center shadow-md hover:bg-red-600 transition-colors" title="עצור">■</button>
                    <button id="fullscreen-button" class="w-10 h-10 bg-blue-500 text-white font-bold rounded-full flex justify-center items-center shadow-md hover:bg-blue-600 transition-colors" title="מסך מלא">⛶</button>
                </div>
            </div>
            
            <div id="stage-aspect-ratio-wrapper" class="w-full relative">
                <div id="stage-area"></div>
            </div>
            
            <!-- Sprites Section -->
            <div class="section">
                <div class="section-header">
                    <h2>דמויות</h2>
                    <div id="add-sprite-button" class="plus-button">+</div>
                </div>
                <div id="sprites-carousel-wrapper" class="relative mt-4">
                    <div id="sprites-list" class="flex items-center gap-4"></div>
                </div>
                
                <!-- Sprite Gallery -->
                <div id="sprite-gallery" class="gallery-container">
                    <button class="close-gallery-button" id="close-sprite-gallery-button">X</button>
                    <h2 class="text-xl font-bold text-center mb-4">גלריית דמויות</h2>
                    <div id="sprite-thumbnails-grid" class="thumbnail-grid">
                        <img src="https://codejredu.github.io/claudejr/Chick.svg" alt="Chick" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/Rabbit.svg" alt="Rabbit" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/GingerCat.svg" alt="GingerCat" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/Dog.svg" alt="Dog" class="thumbnail">
                    </div>
                </div>
            </div>

            <!-- Backdrops Section -->
            <div class="section" id="backdrops-section">
                <div class="section-header">
                    <h2>רקעים</h2>
                    <div id="add-backdrop-button" class="plus-button">+</div>
                </div>
                <div id="backdrops-carousel-wrapper" class="relative mt-4">
                    <div id="backdrops-list" class="flex items-center gap-4"></div>
                </div>
                
                <!-- Background Gallery -->
                <div id="background-gallery" class="gallery-container">
                    <button class="close-gallery-button" id="close-gallery-button">X</button>
                    <h2 class="text-xl font-bold text-center mb-4">גלריית רקעים</h2>
                    <div id="thumbnails-grid" class="thumbnail-grid">
                        <img src="https://codejredu.github.io/test/assets/bg/farm.svg" alt="farm" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/desert.svg" alt="desert" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/canyon.svg" alt="canyon" class="thumbnail">
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <div id="blockly-area" class="h-[80vh] min-h-[500px] w-full rounded-2xl"></div>
        </div>
    </div>
    
    <!-- Blockly Toolbox -->
    <xml id="toolbox" style="display: none">
        <category name="אירועים" colour="#FFD95A">
            <block type="event_when_flag_clicked"></block>
            <block type="event_when_sprite_clicked"></block>
        </category>
        <category name="תנועה" colour="#4C97FF">
            <block type="motion_move_steps">
                <value name="STEPS">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="מראה" colour="#9966FF">
            <block type="looks_say">
                <value name="MESSAGE">
                    <shadow type="text">
                        <field name="TEXT">שלום!</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="מספרים" colour="#40BF4A">
            <block type="math_number"></block>
        </category>
    </xml>

    <script type="module">
        // Constants Module - inline
        const STAGE_CONFIG = {
            WIDTH: 480,
            HEIGHT: 360,
            SPRITE_BASE_SIZE: 80
        };

        // Logger utility - inline  
        class Logger {
            static log(message) {
                console.log(message);
            }
        }

        // Simple Sprite Manager - inline
        class SpriteManager {
            constructor(stageElement) {
                this.sprites = {};
                this.activeSpriteId = null;
                this.stageElement = stageElement;
                this.setupDragListeners();
            }

            createSprite(name, imageUrl, x = 0, y = 0) {
                const id = `sprite-${Date.now()}`;
                const spriteData = {
                    id, name, imageUrl, x, y,
                    direction: 90, opacity: 1, size: 100
                };
                
                this.sprites[id] = spriteData;
                this.createSpriteElements(spriteData);
                this.setActiveSprite(id);
                this.updateSpriteAppearance(id);
                Logger.log(`דמות חדשה נוצרה: ${name}`);
                return spriteData;
            }

            createSpriteElements(spriteData) {
                // Create card
                const card = document.createElement('div');
                card.className = 'sprite-card';
                card.dataset.spriteId = spriteData.id;
                card.innerHTML = `
                    <img src="${spriteData.imageUrl}" alt="${spriteData.name}">
                    <div class="delete-button">X</div>
                `;
                document.getElementById('sprites-list').appendChild(card);

                // Create sprite on stage
                const container = document.createElement('div');
                container.className = 'sprite-container';
                container.id = `container-${spriteData.id}`;

                const wrapper = document.createElement('div');
                wrapper.className = 'sprite-wrapper';
                wrapper.id = spriteData.id;
                wrapper.innerHTML = `
                    <img src="${spriteData.imageUrl}" alt="${spriteData.name}">
                    <div class="speech-bubble"></div>
                `;

                container.appendChild(wrapper);
                this.stageElement.appendChild(container);

                // Event listeners
                card.addEventListener('click', () => this.setActiveSprite(spriteData.id));
                card.querySelector('.delete-button').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.deleteSprite(spriteData.id);
                });
            }

            deleteSprite(id) {
                document.getElementById(`container-${id}`)?.remove();
                document.querySelector(`.sprite-card[data-sprite-id="${id}"]`)?.remove();
                delete this.sprites[id];
                Logger.log(`דמות נמחקה: ${id}`);
            }

            setActiveSprite(spriteId) {
                // Update selection
                document.querySelectorAll('.sprite-card').forEach(card => card.classList.remove('selected'));
                document.querySelector(`.sprite-card[data-sprite-id="${spriteId}"]`)?.classList.add('selected');
                this.activeSpriteId = spriteId;
                Logger.log(`דמות פעילה: ${this.sprites[spriteId]?.name}`);
            }

            updateSpriteAppearance(spriteId) {
                const sprite = this.sprites[spriteId];
                if (!sprite) return;

                const container = document.getElementById(`container-${sprite.id}`);
                const wrapper = document.getElementById(sprite.id);
                
                if (container && wrapper) {
                    const rect = this.stageElement.getBoundingClientRect();
                    const screenX = sprite.x / (STAGE_CONFIG.WIDTH / rect.width);
                    const screenY = -sprite.y / (STAGE_CONFIG.HEIGHT / rect.height);
                    const newSize = STAGE_CONFIG.SPRITE_BASE_SIZE * (sprite.size / 100);

                    wrapper.style.width = `${newSize}px`;
                    wrapper.style.height = `${newSize}px`;
                    wrapper.style.opacity = sprite.opacity;
                    
                    container.style.transform = `translate(${screenX}px, ${screenY}px)`;
                    wrapper.style.transform = `translate(-50%, -50%) rotate(${sprite.direction - 90}deg)`;
                }
            }

            setupDragListeners() {
                // Simplified drag implementation
            }

            getActiveSprite() {
                return this.sprites[this.activeSpriteId] || null;
            }
        }

        // Initialize Custom Blocks
        function initializeCustomBlocks() {
            // Event blocks
            Blockly.Blocks['event_when_flag_clicked'] = {
                init: function() {
                    this.appendDummyInput().appendField('כאשר דגל ירוק נלחץ');
                    this.setNextStatement(true, null);
                    this.setColour("#FFD95A");
                }
            };

            Blockly.Blocks['event_when_sprite_clicked'] = {
                init: function() {
                    this.appendDummyInput().appendField('כאשר דמות זו נלחצת');
                    this.setNextStatement(true, null);
                    this.setColour("#FFD95A");
                }
            };

            // Motion blocks
            Blockly.Blocks['motion_move_steps'] = {
                init: function() {
                    this.appendValueInput("STEPS").setCheck("Number").appendField("זוז");
                    this.appendDummyInput().appendField("צעדים");
                    this.setInputsInline(true);
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#4C97FF");
                }
            };

            // Looks blocks
            Blockly.Blocks['looks_say'] = {
                init: function() {
                    this.appendValueInput("MESSAGE").setCheck("String").appendField("אמור");
                    this.setInputsInline(true);
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#9966FF");
                }
            };

            // JavaScript code generators
            Blockly.JavaScript['event_when_flag_clicked'] = function(block) { return ''; };
            Blockly.JavaScript['event_when_sprite_clicked'] = function(block) { return ''; };
            
            Blockly.JavaScript['motion_move_steps'] = function(block) {
                const steps = Blockly.JavaScript.valueToCode(block, 'STEPS', Blockly.JavaScript.ORDER_ATOMIC) || '10';
                return `
                    if (sprite) {
                        const radians = sprite.direction * Math.PI / 180;
                        sprite.x += (${steps}) * Math.sin(radians);
                        sprite.y += (${steps}) * Math.cos(radians);
                        spriteManager.updateSpriteAppearance(sprite.id);
                        Logger.log(sprite.name + ' זזזה ' + (${steps}) + ' צעדים.');
                    }
                `;
            };

            Blockly.JavaScript['looks_say'] = function(block) {
                const message = Blockly.JavaScript.valueToCode(block, 'MESSAGE', Blockly.JavaScript.ORDER_ATOMIC) || "''";
                return `
                    if (sprite) {
                        const bubble = document.querySelector('#' + sprite.id + ' .speech-bubble');
                        bubble.textContent = ${message};
                        bubble.classList.add('visible');
                        Logger.log(sprite.name + ' אומרת: ' + ${message});
                        setTimeout(() => bubble.classList.remove('visible'), 2000);
                    }
                `;
            };
        }

        // Main Application
        class KidiBlocklyApp {
            constructor() {
                this.workspace = null;
                this.spriteManager = null;
                this.isRunning = false;
                this.init();
            }

            init() {
                initializeCustomBlocks();
                
                this.workspace = Blockly.inject('blockly-area', {
                    toolbox: document.getElementById('toolbox'),
                    rtl: true
                });

                const stageElement = document.getElementById('stage-area');
                this.spriteManager = new SpriteManager(stageElement);
                
                this.setupEventListeners();
                this.createInitialContent();
                
                // Make globally accessible
                window.spriteManager = this.spriteManager;
                Logger.log('אפליקציה הופעלה בהצלחה!');
            }

            setupEventListeners() {
                document.getElementById('run-button').addEventListener('click', () => this.runCode());
                document.getElementById('reset-button').addEventListener('click', () => this.stopCode());
                
                // Gallery buttons
                document.getElementById('add-sprite-button').addEventListener('click', () => {
                    document.getElementById('sprite-gallery').classList.add('visible');
                });
                
                document.getElementById('close-sprite-gallery-button').addEventListener('click', () => {
                    document.getElementById('sprite-gallery').classList.remove('visible');
                });

                document.getElementById('add-backdrop-button').addEventListener('click', () => {
                    document.getElementById('background-gallery').classList.add('visible');
                });
                
                document.getElementById('close-gallery-button').addEventListener('click', () => {
                    document.getElementById('background-gallery').classList.remove('visible');
                });

                // Gallery selections
                document.getElementById('sprite-thumbnails-grid').addEventListener('click', (e) => {
                    if (e.target.tagName === 'IMG') {
                        const name = e.target.alt;
                        const url = e.target.src;
                        this.spriteManager.createSprite(name, url);
                        document.getElementById('sprite-gallery').classList.remove('visible');
                    }
                });

                document.getElementById('thumbnails-grid').addEventListener('click', (e) => {
                    if (e.target.tagName === 'IMG') {
                        const url = e.target.src;
                        this.switchBackdrop(url);
                        document.getElementById('background-gallery').classList.remove('visible');
                    }
                });
            }

            createInitialContent() {
                // Default backdrop
                const backdropsList = document.getElementById('backdrops-list');
                const defaultBackdrop = document.createElement('div');
                defaultBackdrop.className = 'backdrop-card selected';
                const defaultUrl = 'https://codejredu.github.io/test/assets/bg/farm.svg';
                defaultBackdrop.style.backgroundImage = `url("${defaultUrl}")`;
                backdropsList.appendChild(defaultBackdrop);
                this.switchBackdrop(defaultUrl);

                // Default sprite
                this.spriteManager.createSprite('חתול', 'https://codejredu.github.io/claudejr/GingerCat.svg');
            }

            switchBackdrop(url) {
                document.getElementById('stage-area').style.backgroundImage = `url("${url}")`;
                Logger.log(`רקע הוחלף: ${url}`);
            }

            async runCode() {
                if (this.isRunning) return;
                this.isRunning = true;

                const sprite = this.spriteManager.getActiveSprite();
                if (!sprite) {
                    Logger.log('אין דמות פעילה');
                    this.isRunning = false;
                    return;
                }

                // Find flag clicked blocks
                const topBlocks = this.workspace.getTopBlocks(true);
                const flagBlocks = topBlocks.filter(block => block.type === 'event_when_flag_clicked');
                
                if (flagBlocks.length === 0) {
                    Logger.log('לא נמצא בלוק דגל ירוק');
                    this.isRunning = false;
                    return;
                }

                Logger.log('מתחיל להריץ תסריט...');

                for (const flagBlock of flagBlocks) {
                    let currentBlock = flagBlock.getNextBlock();
                    while (currentBlock) {
                        const code = Blockly.JavaScript.blockToCode(currentBlock);
                        if (code) {
                            try {
                                const AsyncFunction = Object.getPrototypeOf(async function(){}).constructor;
                                const func = new AsyncFunction('sprite', 'spriteManager', 'Logger', code);
                                await func(sprite, this.spriteManager, Logger);
                            } catch (e) {
                                Logger.log('שגיאה: ' + e.message);
                            }
                        }
                        currentBlock = currentBlock.getNextBlock();
                        await this.delay(100); // Small delay between blocks
                    }
                }

                Logger.log('תסריט הסתיים');
                this.isRunning = false;
            }

            stopCode() {
                this.isRunning = false;
                Logger.log('תסריט הופסק');
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new KidiBlocklyApp();
        });
    </script>
</body>
</html>
