 <!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בלוקלי: מיקום מרכזי</title>
    <!-- הוספת תגית CSP כדי לאפשר טעינת סקריפטים חיצוניים -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdn.tailwindcss.com; img-src 'self' data: https:;"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .container-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 1rem;
        }
        @media (min-width: 1024px) {
            .container-wrapper {
                flex-direction: row-reverse;
            }
        }
        #stage-area {
            position: relative;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 480px;
            height: 360px;
            flex-shrink: 0;
            margin: 0 auto 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid #ccc;
            background-size: cover;
            background-position: center;
        }
        @media (min-width: 1024px) {
            #stage-area {
                margin: 0 1rem 0 0;
            }
        }
        #cat-sprite {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80px;
            height: 80px;
            background-color: transparent;
            border-radius: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            transform: translate(calc(-50% + 0px), calc(-50% + 0px));
            transition: transform 0.1s ease-out; /* מהירות מעבר מהירה יותר לגרירה */
            z-index: 10;
            opacity: 1;
            cursor: grab; /* שינוי סמן העכבר לגרירה */
        }
        #cat-sprite:active {
            cursor: grabbing;
        }
        #cat-sprite img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 0;
        }
        .speech-bubble {
            position: absolute;
            background: #fdfd96;
            border-radius: 12px;
            padding: 8px 12px;
            border: 1px solid #ccc;
            white-space: nowrap;
            font-size: 0.9rem;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .speech-bubble::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 100%;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-top-color: #fdfd96;
            border-bottom: 0;
            margin-left: -8px;
            margin-top: -1px;
        }
        .speech-bubble.visible {
            opacity: 1;
        }
        #blockly-area {
            flex-grow: 1;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: 100%;
        }
        .controls-and-blockly {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        #console-output {
            position: absolute;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 8px;
            font-size: 0.8rem;
            max-height: 80px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        /* גלריה */
        .gallery-container {
            width: 100%;
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f0f4f8;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: none; /* הסתרה כברירת מחדל */
            transition: all 0.5s ease-in-out;
        }
        .gallery-container.visible {
            display: block;
        }
        .thumbnail-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
        .thumbnail {
            width: 100%;
            height: auto;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .thumbnail.selected {
            border: 3px solid #4C97FF;
        }
        /* רקעים אחרונים שנבחרו */
        #recent-backgrounds-container {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 0.5rem;
            padding: 0.5rem 0;
            width: 100%;
            margin-top: 1rem;
        }
        .recent-background {
            width: 60px;
            height: 45px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            object-fit: cover;
            flex-shrink: 0;
            transition: border-color 0.2s;
        }
        .recent-background.selected {
            border-color: #4C97FF;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="container-wrapper" class="container-wrapper">
        <!-- אזור הבמה והדמות -->
        <div class="flex-1 lg:w-1/2 flex flex-col items-center">
            <h1 class="text-3xl font-bold mb-4 text-center">במה של החתול</h1>
            <div id="stage-area" class="w-full lg:w-auto p-4 flex flex-col justify-center rounded-2xl">
                <div class="relative w-full h-full flex items-center justify-center">
                    <div id="cat-sprite">
                        <img src="https://codejredu.github.io/claudejr/GingerCat.svg" alt="חתול ג'ינג'י">
                        <div id="speech-bubble" class="speech-bubble"></div>
                    </div>
                </div>
                <div id="console-output">
                    <b>פלט קונסול:</b>
                </div>
            </div>

            <!-- תצוגה של הרקעים האחרונים שנבחרו -->
            <div id="recent-backgrounds-container" class="recent-backgrounds-container">
                <!-- כאן יוצגו הרקעים שנבחרו -->
            </div>
            
            <!-- גלריית רקעים -->
            <div id="background-gallery" class="gallery-container">
                <h2 class="text-xl font-bold text-center mb-4">גלריית רקעים</h2>
                <div id="thumbnails-grid" class="thumbnail-grid">
                    <img src="https://codejredu.github.io/test/assets/bg/Amphitheater.svg" alt="Amphitheater" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/canyon.svg" alt="canyon" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/canyon1.svg" alt="canyon1" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/castel.svg" alt="castel" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/castel1.svg" alt="castel1" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/citynight.svg" alt="citynight" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/citynight2.svg" alt="citynight2" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/colorfulcity.svg" alt="colorfulcity" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/colorfulcity1.svg" alt="colorfulcity1" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/desert.svg" alt="desert" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/desert1.svg" alt="desert1" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/farm.svg" alt="farm" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/kidbadroom.svg" alt="kidbadroom" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/kidbadroom1.svg" alt="kidbadroom1" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/moon.svg" alt="moon" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/road1.svg" alt="road1" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/road2.svg" alt="road2" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/room1.svg" alt="room1" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/room2.svg" alt="room2" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/savanna1.svg" alt="savanna1" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/savanna2.svg" alt="savanna2" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/school1.svg" alt="school1" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/slopes1.svg" alt="slopes1" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/slopes2.svg" alt="slopes2" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/soccer1.svg" alt="soccer1" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/soccer2.svg" alt="soccer2" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/winter1.svg" alt="winter1" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/winter2.svg" alt="winter2" class="thumbnail">
                    <img src="https://codejredu.github.io/test/assets/bg/under.svg" alt="under" class="thumbnail">
                </div>
            </div>
        </div>

        <!-- אזור הבלוקלי והפקדים -->
        <div class="controls-and-blockly w-full mt-4 lg:w-1/2 lg:mt-0">
            <div id="blockly-area" class="h-[calc(100vh-16rem)] lg:h-[calc(100vh-2rem)] w-full rounded-2xl"></div>
            <div class="flex flex-row space-x-2 space-x-reverse justify-center mt-4">
                <button id="run-button" class="px-6 py-3 bg-green-500 text-white font-bold rounded-full shadow-md hover:bg-green-600 transition-colors">
                    <span class="ml-2">הפעל</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.127l-3.328 2.378a.999.999 0 01-1.424-.712V8.92c0-.525.53-.787 1.055-.443l3.328 2.378a.999.999 0 01-.031 1.094z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
                <button id="reset-button" class="px-6 py-3 bg-red-500 text-white font-bold rounded-full shadow-md hover:bg-red-600 transition-colors">
                    <span class="ml-2">אפס</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m16.733 11.234A9.975 9.975 0 0112 21c-5.523 0-10-4.477-10-10S6.477 1 12 1s10 4.477 10 10c0 .487-.04.965-.118 1.432m-11.234 3.733l-4 4L4 16m9-13.885v3.424m-4.542 6.556l-3.79-3.79M17.458 12.062L13.668 15.852" />
                    </svg>
                </button>
                <button id="fullscreen-button" class="px-6 py-3 bg-blue-500 text-white font-bold rounded-full shadow-md hover:bg-blue-600 transition-colors">
                    <span class="ml-2">מסך מלא</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m0 0l-5 5m0 5v4m0 0h4m0 0l-5-5m-9 5v4m0 0h-4m0 0l5-5" />
                    </svg>
                </button>
                <button id="toggle-gallery-button" class="px-6 py-3 bg-purple-500 text-white font-bold rounded-full shadow-md hover:bg-purple-600 transition-colors">
                    <span class="ml-2"> רקעים</span>
                    <svg id="gallery-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <xml id="toolbox" style="display: none">
        <!-- תפריט הבלוקים -->
        <category name="אירועים" colour="#FFD95A">
            <block type="event_when_flag_clicked"></block>
            <block type="event_when_key_pressed"></block>
            <block type="event_when_stage_clicked"></block>
        </category>
        <category name="תנועה" colour="#4C97FF">
            <block type="motion_move_steps">
                <value name="STEPS">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="motion_turn_right_degrees">
                <value name="DEGREES">
                    <shadow type="math_number">
                        <field name="NUM">15</field>
                    </shadow>
                </value>
            </block>
            <block type="motion_turn_left_degrees">
                <value name="DEGREES">
                    <shadow type="math_number">
                        <field name="NUM">15</field>
                    </shadow>
                </value>
            </block>
            <block type="motion_go_to_xy">
                <value name="X">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
                <value name="Y">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
            </block>
            <block type="motion_glide_to_xy">
                <value name="SECS">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="X">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
                <value name="Y">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="מראה" colour="#9966FF">
            <block type="looks_say_for_secs">
                <value name="MESSAGE">
                    <shadow type="text">
                        <field name="TEXT">שלום!</field>
                    </shadow>
                </value>
                <value name="SECS">
                    <shadow type="math_number">
                        <field name="NUM">2</field>
                    </shadow>
                </value>
            </block>
            <block type="looks_say">
                <value name="MESSAGE">
                    <shadow type="text">
                        <field name="TEXT">שלום!</field>
                    </shadow>
                </value>
            </block>
            <block type="looks_show"></block>
            <block type="looks_hide"></block>
            <block type="looks_set_transparency">
                <value name="TRANSPARENCY">
                    <shadow type="math_number">
                        <field name="NUM">50</field>
                    </shadow>
                </value>
            </block>
            <block type="looks_set_sprite">
                <value name="URL">
                    <shadow type="text">
                        <field name="TEXT">https://codejredu.github.io/claudejr/GingerCat.svg</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="בקרה" colour="#FF6B1A">
            <block type="control_wait_secs">
                <value name="SECS">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
            <block type="control_repeat_times">
                <value name="TIMES">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
                <statement name="DO">
                    <!-- קלט פנימי -->
                </statement>
            </block>
            <block type="control_forever"></block>
        </category>
        <category name="אופרטורים" colour="#40BF4A">
            <block type="operator_add"></block>
            <block type="operator_subtract"></block>
            <block type="operator_multiply"></block>
            <block type="operator_divide"></block>
            <block type="operator_random_number">
                <field name="FROM">1</field>
                <field name="TO">10</field>
            </block>
        </category>
    </xml>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // טעינת ספריית Blockly באופן דינמי
            const script = document.createElement('script');
            script.src = "https://unpkg.com/blockly@9.0.0/blockly.min.js";
            script.onload = () => {
                initializeBlockly();
            };
            document.head.appendChild(script);

            const initializeBlockly = () => {
                const catSprite = document.getElementById('cat-sprite');
                const stageArea = document.getElementById('stage-area');
                const speechBubble = document.getElementById('speech-bubble');
                const consoleOutput = document.getElementById('console-output');
                const containerWrapper = document.getElementById('container-wrapper');
                const fullscreenButton = document.getElementById('fullscreen-button');
                const toggleGalleryButton = document.getElementById('toggle-gallery-button');
                const backgroundGallery = document.getElementById('background-gallery');
                const recentBackgroundsContainer = document.getElementById('recent-backgrounds-container');

                const thumbnailsGrid = document.getElementById('thumbnails-grid');
                const thumbnails = document.querySelectorAll('#thumbnails-grid .thumbnail');

                let workspace;
                let currentX = 0;
                let currentY = 0;
                let currentDirection = 90;
                let recentBackgrounds = [];
                const MAX_RECENT_BACKGROUNDS = 6;
                
                // משתנים עבור גרירה
                let isDragging = false;
                let initialMouseX;
                let initialMouseY;
                let initialCatX;
                let initialCatY;

                const logToConsole = (message) => {
                    const p = document.createElement('p');
                    p.textContent = message;
                    consoleOutput.appendChild(p);
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                };

                const updateCatPosition = () => {
                    catSprite.style.transform = `translate(calc(-50% + ${currentX}px), calc(-50% + ${currentY}px)) rotate(${currentDirection - 90}deg)`;
                };

                // פונקציות גרירה - תמיכה בעכבר וטאץ'
                const getPointerPosition = (e) => {
                    const isTouch = e.touches && e.touches.length > 0;
                    return {
                        x: isTouch ? e.touches[0].clientX : e.clientX,
                        y: isTouch ? e.touches[0].clientY : e.clientY
                    };
                };
                
                const startDrag = (e) => {
                    e.preventDefault();
                    isDragging = true;
                    const { x, y } = getPointerPosition(e);
                    initialMouseX = x;
                    initialMouseY = y;
                    initialCatX = currentX;
                    initialCatY = currentY;
                    catSprite.style.transition = 'none';
                    logToConsole('החתול נתפס לגרירה.');
                };

                const drag = (e) => {
                    if (isDragging) {
                        const { x, y } = getPointerPosition(e);
                        const deltaX = x - initialMouseX;
                        const deltaY = y - initialMouseY;
                        
                        currentX = initialCatX + deltaX;
                        currentY = initialCatY + deltaY;
                        
                        updateCatPosition();
                    }
                };

                const endDrag = () => {
                    if (isDragging) {
                        isDragging = false;
                        catSprite.style.transition = 'transform 0.5s ease-out';
                        logToConsole(`החתול נגרר למיקום חדש (x: ${currentX.toFixed(0)}, y: ${currentY.toFixed(0)})`);
                    }
                };

                // מאזיני אירועים לגרירה - עכבר וטאץ'
                catSprite.addEventListener('mousedown', startDrag);
                catSprite.addEventListener('touchstart', startDrag);

                stageArea.addEventListener('mousemove', drag);
                stageArea.addEventListener('touchmove', drag);

                document.addEventListener('mouseup', endDrag);
                document.addEventListener('touchend', endDrag);
                document.addEventListener('touchcancel', endDrag);
                
                // הגדרת בלוקים מותאמים אישית
                Blockly.Blocks['event_when_flag_clicked'] = {
                    init: function() {
                        this.appendDummyInput()
                            .appendField("כאשר");
                        this.appendDummyInput()
                            .appendField(new Blockly.FieldImage("https://www.gstatic.com/codesite/ph/images/play_button.gif", 15, 15, { alt: "דגל", flipRtl: "false" }));
                        this.appendDummyInput()
                            .appendField("נלחץ");
                        this.setNextStatement(true, null);
                        this.setColour("#FFD95A");
                        this.setTooltip("התחל את התסריט כאשר הדגל הירוק נלחץ.");
                        this.setHelpUrl("");
                    }
                };
                Blockly.JavaScript['event_when_flag_clicked'] = function(block) {
                    return '';
                };
                Blockly.Blocks['event_when_key_pressed'] = {
                    init: function() {
                        this.appendDummyInput()
                            .appendField("כאשר מקש")
                            .appendField(new Blockly.FieldDropdown([
                                ["רווח", "SPACE"],
                                ["חץ למעלה", "UP"],
                                ["חץ למטה", "DOWN"],
                                ["חץ ימינה", "RIGHT"],
                                ["חץ שמאלה", "LEFT"]
                            ]), "KEY")
                            .appendField("נלחץ");
                        this.setNextStatement(true, null);
                        this.setColour("#FFD95A");
                        this.setTooltip("הפעל קוד כאשר מקש נלחץ. (פונקציונליות זו אינה נתמכת במלואה בדוגמה הנוכחית.)");
                        this.setHelpUrl("");
                    }
                };
                Blockly.JavaScript['event_when_key_pressed'] = function(block) {
                    return '';
                };
                // בלוק חדש: כאשר לוחצים על הבמה
                Blockly.Blocks['event_when_stage_clicked'] = {
                    init: function() {
                        this.appendDummyInput()
                            .appendField("כאשר הבמה נלחצת");
                        this.setNextStatement(true, null);
                        this.setColour("#FFD95A");
                        this.setTooltip("הפעל את התסריט כאשר לוחצים על אזור הבמה.");
                        this.setHelpUrl("");
                    }
                };
                Blockly.JavaScript['event_when_stage_clicked'] = function(block) {
                    return '';
                };

                // תנועה
                Blockly.Blocks['motion_move_steps'] = {
                    init: function() {
                        this.appendValueInput("STEPS")
                            .setCheck("Number")
                            .appendField("לך")
                            .appendField("צעדים");
                        this.setPreviousStatement(true, null);
                        this.setNextStatement(true, null);
                        this.setColour("#4C97FF");
                        this.setTooltip("הזז את הדמות בכיוון שהיא פונה.");
                    }
                };
                Blockly.JavaScript['motion_move_steps'] = function(block) {
                    const steps = Blockly.JavaScript.valueToCode(block, 'STEPS', Blockly.JavaScript.ORDER_NONE) || '10';
                    const code = `
                        await new Promise(resolve => {
                            const radians = (currentDirection - 90) * Math.PI / 180;
                            currentX += (${steps} * Math.cos(radians));
                            currentY -= (${steps} * Math.sin(radians));
                            updateCatPosition();
                            logToConsole('החתול זז ' + ${steps} + ' צעדים.');
                            setTimeout(resolve, 500);
                        });
                    `;
                    return code;
                };
                Blockly.Blocks['motion_turn_right_degrees'] = {
                    init: function() {
                        this.appendValueInput("DEGREES")
                            .setCheck("Number")
                            .appendField("הסתובב ימינה")
                            .appendField("מעלות");
                        this.setPreviousStatement(true, null);
                        this.setNextStatement(true, null);
                        this.setColour("#4C97FF");
                        this.setTooltip("סובב את הדמות ימינה.");
                    }
                };
                Blockly.JavaScript['motion_turn_right_degrees'] = function(block) {
                    const degrees = Blockly.JavaScript.valueToCode(block, 'DEGREES', Blockly.JavaScript.ORDER_ATOMIC) || '15';
                    const code = `
                        await new Promise(resolve => {
                            currentDirection += ${degrees};
                            updateCatPosition();
                            logToConsole('החתול הסתובב ימינה ב-' + ${degrees} + ' מעלות.');
                            setTimeout(resolve, 10);
                        });
                    `;
                    return code;
                };
                Blockly.Blocks['motion_turn_left_degrees'] = {
                    init: function() {
                        this.appendValueInput("DEGREES")
                            .setCheck("Number")
                            .appendField("הסתובב שמאלה")
                            .appendField("מעלות");
                        this.setPreviousStatement(true, null);
                        this.setNextStatement(true, null);
                        this.setColour("#4C97FF");
                        this.setTooltip("סובב את הדמות שמאלה.");
                    }
                };
                Blockly.JavaScript['motion_turn_left_degrees'] = function(block) {
                    const degrees = Blockly.JavaScript.valueToCode(block, 'DEGREES', Blockly.JavaScript.ORDER_ATOMIC) || '15';
                    const code = `
                        await new Promise(resolve => {
                            currentDirection -= ${degrees};
                            updateCatPosition();
                            logToConsole('החתול הסתובב שמאלה ב-' + ${degrees} + ' מעלות.');
                            setTimeout(resolve, 10);
                        });
                    `;
                    return code;
                };
                Blockly.Blocks['motion_go_to_xy'] = {
                    init: function() {
                        this.appendValueInput("X")
                            .setCheck("Number")
                            .appendField("קפוץ ל-x:");
                        this.appendValueInput("Y")
                            .setCheck("Number")
                            .appendField("y:");
                        this.setPreviousStatement(true, null);
                        this.setNextStatement(true, null);
                        this.setColour("#4C97FF");
                        this.setTooltip("קפיצה למיקום מסוים על הבמה.");
                    }
                };
                Blockly.JavaScript['motion_go_to_xy'] = function(block) {
                    const x = Blockly.JavaScript.valueToCode(block, 'X', Blockly.JavaScript.ORDER_ATOMIC) || '0';
                    const y = Blockly.JavaScript.valueToCode(block, 'Y', Blockly.JavaScript.ORDER_ATOMIC) || '0';
                    const code = `
                        await new Promise(resolve => {
                            currentX = ${x};
                            currentY = -${y};
                            updateCatPosition();
                            logToConsole('קפץ ל-x: ' + ${x} + ' y: ' + ${y});
                            resolve();
                        });
                    `;
                    return code;
                };
                Blockly.Blocks['motion_glide_to_xy'] = {
                    init: function() {
                        this.appendValueInput("SECS")
                            .setCheck("Number")
                            .appendField("החלק")
                            .appendField("שניות");
                        this.appendValueInput("X")
                            .setCheck("Number")
                            .appendField("ל-x:");
                        this.appendValueInput("Y")
                            .setCheck("Number")
                            .appendField("y:");
                        this.setPreviousStatement(true, null);
                        this.setNextStatement(true, null);
                        this.setColour("#4C97FF");
                        this.setTooltip("החלק את הדמות בצורה חלקה למיקום מסוים.");
                    }
                };
                Blockly.JavaScript['motion_glide_to_xy'] = function(block) {
                    const secs = Blockly.JavaScript.valueToCode(block, 'SECS', Blockly.JavaScript.ORDER_ATOMIC) || '1';
                    const x = Blockly.JavaScript.valueToCode(block, 'X', Blockly.JavaScript.ORDER_ATOMIC) || '0';
                    const y = Blockly.JavaScript.valueToCode(block, 'Y', Blockly.JavaScript.ORDER_ATOMIC) || '0';
                    const code = `
                        await new Promise(resolve => {
                            catSprite.style.transition = 'transform ' + ${secs} + 's ease-in-out';
                            currentX = ${x};
                            currentY = -${y};
                            updateCatPosition();
                            logToConsole('החתול מחליק ל-x: ' + ${x} + ' y: ' + ${y});
                            setTimeout(() => {
                                catSprite.style.transition = 'transform 0.1s ease-out';
                                resolve();
                            }, ${secs} * 1000);
                        });
                    `;
                    return code;
                };

                // מראה
                Blockly.Blocks['looks_say_for_secs'] = {
                    init: function() {
                        this.appendValueInput("MESSAGE")
                            .setCheck("String")
                            .appendField("אמור");
                        this.appendValueInput("SECS")
                            .setCheck("Number")
                            .appendField("למשך")
                            .appendField("שניות");
                        this.setPreviousStatement(true, null);
                        this.setNextStatement(true, null);
                        this.setColour("#9966FF");
                        this.setTooltip("הצג בועת דיבור.");
                    }
                };
                Blockly.JavaScript['looks_say_for_secs'] = function(block) {
                    const message = Blockly.JavaScript.valueToCode(block, 'MESSAGE', Blockly.JavaScript.ORDER_ATOMIC) || '"שלום!"';
                    const code = `
                        await new Promise(resolve => {
                            speechBubble.textContent = ${message.replace(/'/g, "")};
                            speechBubble.classList.add('visible');
                            logToConsole('אומר: ' + ${message});
                            setTimeout(() => {
                                speechBubble.classList.remove('visible');
                                resolve();
                            }, ${Blockly.JavaScript.valueToCode(block, 'SECS', Blockly.JavaScript.ORDER_ATOMIC) || '2'} * 1000);
                        });
                    `;
                    return code;
                };
                Blockly.Blocks['looks_say'] = {
                    init: function() {
                        this.appendValueInput("MESSAGE")
                            .setCheck("String")
                            .appendField("אמור");
                        this.setPreviousStatement(true, null);
                        this.setNextStatement(true, null);
                        this.setColour("#9966FF");
                        this.setTooltip("הצג בועת דיבור.");
                    }
                };
                Blockly.JavaScript['looks_say'] = function(block) {
                    const message = Blockly.JavaScript.valueToCode(block, 'MESSAGE', Blockly.JavaScript.ORDER_ATOMIC) || '"שלום!"';
                    const code = `
                        await new Promise(resolve => {
                            speechBubble.textContent = ${message.replace(/'/g, "")};
                            speechBubble.classList.add('visible');
                            logToConsole('אומר: ' + ${message});
                            resolve();
                        });
                    `;
                    return code;
                };
                Blockly.Blocks['looks_show'] = {
                    init: function() {
                        this.appendDummyInput()
                            .appendField("הצג");
                        this.setPreviousStatement(true, null);
                        this.setNextStatement(true, null);
                        this.setColour("#9966FF");
                        this.setTooltip("הצג את הדמות.");
                    }
                };
                Blockly.JavaScript['looks_show'] = function(block) {
                    const code = `
                        await new Promise(resolve => {
                            catSprite.style.display = 'flex';
                            logToConsole('החתול מופיע.');
                            resolve();
                        });
                    `;
                    return code;
                };
                Blockly.Blocks['looks_hide'] = {
                    init: function() {
                        this.appendDummyInput()
                            .appendField("הסתר");
                        this.setPreviousStatement(true, null);
                        this.setNextStatement(true, null);
                        this.setColour("#9966FF");
                        this.setTooltip("הסתר את הדמות.");
                    }
                };
                Blockly.JavaScript['looks_hide'] = function(block) {
                    const code = `
                        await new Promise(resolve => {
                            catSprite.style.display = 'none';
                            logToConsole('החתול הוסתר.');
                            resolve();
                        });
                    `;
                    return code;
                };
                Blockly.Blocks['looks_set_transparency'] = {
                    init: function() {
                        this.appendValueInput("TRANSPARENCY")
                            .setCheck("Number")
                            .appendField("שנה שקיפות ל-");
                        this.setPreviousStatement(true, null);
                        this.setNextStatement(true, null);
                        this.setColour("#9966FF");
                        this.setTooltip("שנה את שקיפות הדמות (0-100).");
                    }
                };
                Blockly.JavaScript['looks_set_transparency'] = function(block) {
                    const transparency = Blockly.JavaScript.valueToCode(block, 'TRANSPARENCY', Blockly.JavaScript.ORDER_ATOMIC) || '100';
                    const code = `
                        await new Promise(resolve => {
                            let opacityValue = Math.max(0, Math.min(1, ${transparency} / 100));
                            catSprite.style.opacity = opacityValue;
                            logToConsole('שקיפות החתול שונתה ל-' + ${transparency} + '%');
                            resolve();
                        });
                    `;
                    return code;
                };
                Blockly.Blocks['looks_set_sprite'] = {
                    init: function() {
                        this.appendValueInput("URL")
                            .setCheck("String")
                            .appendField("שנה דמות ל-SVG מקישור");
                        this.setPreviousStatement(true, null);
                        this.setNextStatement(true, null);
                        this.setColour("#9966FF");
                        this.setTooltip("שנה את מראה הדמות לקובץ SVG מקישור.");
                    }
                };
                Blockly.JavaScript['looks_set_sprite'] = function(block) {
                    const url = Blockly.JavaScript.valueToCode(block, 'URL', Blockly.JavaScript.ORDER_ATOMIC) || '""';
                    const code = `
                        await new Promise(resolve => {
                            const svgUrl = ${url};
                            const imgElement = document.createElement('img');
                            imgElement.src = svgUrl;
                            imgElement.onload = () => {
                                catSprite.innerHTML = '';
                                catSprite.style.backgroundColor = 'transparent';
                                catSprite.style.borderRadius = '0';
                                catSprite.appendChild(imgElement);
                                logToConsole('הדמות שונתה לקובץ SVG.');
                                resolve();
                            };
                            imgElement.onerror = () => {
                                logToConsole('שגיאה בטעינת קובץ SVG מהקישור.');
                                resolve();
                            };
                        });
                    `;
                    return code;
                };

                // בקרה
                Blockly.Blocks['control_wait_secs'] = {
                    init: function() {
                        this.appendValueInput("SECS")
                            .setCheck("Number")
                            .appendField("המתן")
                            .appendField("שניות");
                        this.setPreviousStatement(true, null);
                        this.setNextStatement(true, null);
                        this.setColour("#FF6B1A");
                        this.setTooltip("המתן מספר שניות.");
                    }
                };
                Blockly.JavaScript['control_wait_secs'] = function(block) {
                    const secs = Blockly.JavaScript.valueToCode(block, 'SECS', Blockly.JavaScript.ORDER_ATOMIC) || '1';
                    const code = `
                        await new Promise(resolve => {
                            logToConsole('ממתין ' + ${secs} + ' שניות...');
                            setTimeout(resolve, ${secs} * 1000);
                        });
                    `;
                    return code;
                };
                Blockly.Blocks['control_repeat_times'] = {
                    init: function() {
                        this.appendDummyInput()
                            .appendField("חזור");
                        this.appendValueInput("TIMES")
                            .setCheck("Number");
                        this.appendDummyInput()
                            .appendField("פעמים");
                        this.appendStatementInput("DO")
                            .setCheck(null);
                        this.setPreviousStatement(true, null);
                        this.setNextStatement(true, null);
                        this.setColour("#FF6B1A");
                        this.setTooltip("חזור על הבלוקים שבפנים מספר פעמים.");
                    }
                };
                Blockly.JavaScript['control_repeat_times'] = function(block) {
                    const times = Blockly.JavaScript.valueToCode(block, 'TIMES', Blockly.JavaScript.ORDER_ATOMIC) || '10';
                    const doCode = Blockly.JavaScript.statementToCode(block, 'DO');
                    const code = `
                        logToConsole('מתחיל חזרה על ' + ${times} + ' פעמים.');
                        for (let i = 0; i < ${times}; i++) {
                            await (async () => {
                                ${doCode}
                            })();
                        }
                    `;
                    return code;
                };
                Blockly.Blocks['control_forever'] = {
                    init: function() {
                        this.appendDummyInput().appendField("לעולמים");
                        this.appendStatementInput("DO").setCheck(null);
                        this.setPreviousStatement(true, null);
                        this.setNextStatement(true, null);
                        this.setColour("#FF6B1A");
                        this.setTooltip("חזור על הבלוקים ללא הפסקה. (עשוי להיתקע - יש להשתמש בזהירות)");
                    }
                };
                Blockly.JavaScript['control_forever'] = function(block) {
                    const doCode = Blockly.JavaScript.statementToCode(block, 'DO');
                    const code = `
                        logToConsole('מתחיל לולאת לנצח...');
                        while(true) {
                            await new Promise(resolve => setTimeout(resolve, 10));
                            await (async () => {
                                ${doCode}
                            })();
                        }
                    `;
                    return code;
                };

                // אופרטורים
                Blockly.Blocks['operator_add'] = {
                    init: function() {
                        this.appendValueInput("NUM1").setCheck("Number");
                        this.appendValueInput("NUM2").setCheck("Number").appendField("+");
                        this.setOutput(true, "Number");
                        this.setColour("#40BF4A");
                        this.setTooltip("מחבר שני מספרים.");
                    }
                };
                Blockly.JavaScript['operator_add'] = function(block) {
                    const num1 = Blockly.JavaScript.valueToCode(block, 'NUM1', Blockly.JavaScript.ORDER_ADDITION) || '0';
                    const num2 = Blockly.JavaScript.valueToCode(block, 'NUM2', Blockly.JavaScript.ORDER_ADDITION) || '0';
                    const code = `(${num1} + ${num2})`;
                    return [code, Blockly.JavaScript.ORDER_ADDITION];
                };
                Blockly.Blocks['operator_subtract'] = {
                    init: function() {
                        this.appendValueInput("NUM1").setCheck("Number");
                        this.appendValueInput("NUM2").setCheck("Number").appendField("-");
                        this.setOutput(true, "Number");
                        this.setColour("#40BF4A");
                        this.setTooltip("מחסר שני מספרים.");
                    }
                };
                Blockly.JavaScript['operator_subtract'] = function(block) {
                    const num1 = Blockly.JavaScript.valueToCode(block, 'NUM1', Blockly.JavaScript.ORDER_SUBTRACTION) || '0';
                    const num2 = Blockly.JavaScript.valueToCode(block, 'NUM2', Blockly.JavaScript.ORDER_SUBTRACTION) || '0';
                    const code = `(${num1} - ${num2})`;
                    return [code, Blockly.JavaScript.ORDER_SUBTRACTION];
                };
                Blockly.Blocks['operator_multiply'] = {
                    init: function() {
                        this.appendValueInput("NUM1").setCheck("Number");
                        this.appendValueInput("NUM2").setCheck("Number").appendField("×");
                        this.setOutput(true, "Number");
                        this.setColour("#40BF4A");
                        this.setTooltip("מכפיל שני מספרים.");
                    }
                };
                Blockly.JavaScript['operator_multiply'] = function(block) {
                    const num1 = Blockly.JavaScript.valueToCode(block, 'NUM1', Blockly.JavaScript.ORDER_MULTIPLICATION) || '0';
                    const num2 = Blockly.JavaScript.valueToCode(block, 'NUM2', Blockly.JavaScript.ORDER_MULTIPLICATION) || '0';
                    const code = `(${num1} * ${num2})`;
                    return [code, Blockly.JavaScript.ORDER_MULTIPLICATION];
                };
                Blockly.Blocks['operator_divide'] = {
                    init: function() {
                        this.appendValueInput("NUM1").setCheck("Number");
                        this.appendValueInput("NUM2").setCheck("Number").appendField("÷");
                        this.setOutput(true, "Number");
                        this.setColour("#40BF4A");
                        this.setTooltip("מחלק שני מספרים.");
                    }
                };
                Blockly.JavaScript['operator_divide'] = function(block) {
                    const num1 = Blockly.JavaScript.valueToCode(block, 'NUM1', Blockly.JavaScript.ORDER_DIVISION) || '0';
                    const num2 = Blockly.JavaScript.valueToCode(block, 'NUM2', Blockly.JavaScript.ORDER_DIVISION) || '0';
                    const code = `(${num1} / ${num2})`;
                    return [code, Blockly.JavaScript.ORDER_DIVISION];
                };
                Blockly.Blocks['operator_random_number'] = {
                    init: function() {
                        this.appendDummyInput()
                            .appendField("בחר מספר אקראי מ-")
                            .appendField(new Blockly.FieldTextInput("1"), "FROM")
                            .appendField("עד")
                            .appendField(new Blockly.FieldTextInput("10"), "TO");
                        this.setOutput(true, "Number");
                        this.setColour("#40BF4A");
                        this.setTooltip("בחר מספר אקראי בטווח שצוין.");
                    }
                };
                Blockly.JavaScript['operator_random_number'] = function(block) {
                    const from = block.getFieldValue('FROM');
                    const to = block.getFieldValue('TO');
                    const code = `Math.floor(Math.random() * (${to} - ${from} + 1)) + ${from}`;
                    return [code, Blockly.JavaScript.ORDER_FUNCTION_CALL];
                };

                const resetCatPosition = () => {
                    currentX = 0;
                    currentY = 0;
                    currentDirection = 90;
                    updateCatPosition();
                    catSprite.style.opacity = 1;
                    speechBubble.classList.remove('visible');
                    consoleOutput.innerHTML = '<b>פלט קונסול:</b>';
                    const imgElement = document.createElement('img');
                    imgElement.src = 'https://codejredu.github.io/claudejr/GingerCat.svg';
                    catSprite.innerHTML = '';
                    catSprite.appendChild(imgElement);
                    logToConsole('הבמה אופסה. החתול נמצא במיקום (0,0), במרכז הבמה.');
                };

                const updateRecentBackgrounds = (newBackground) => {
                    // בדוק אם הרקע כבר קיים ברשימה
                    const existingIndex = recentBackgrounds.findIndex(bg => bg.src === newBackground.src);
                    if (existingIndex !== -1) {
                        // אם קיים, הסר אותו כדי להזיז אותו לראש הרשימה
                        recentBackgrounds.splice(existingIndex, 1);
                    }
                    // הוסף את הרקע החדש לראש הרשימה
                    recentBackgrounds.unshift(newBackground);
                    // שמור רק על 6 הרקעים האחרונים
                    if (recentBackgrounds.length > MAX_RECENT_BACKGROUNDS) {
                        recentBackgrounds.pop();
                    }
                    renderRecentBackgrounds();
                };

                const renderRecentBackgrounds = () => {
                    recentBackgroundsContainer.innerHTML = '';
                    recentBackgrounds.forEach(bg => {
                        const img = document.createElement('img');
                        img.src = bg.src;
                        img.alt = bg.alt;
                        img.classList.add('recent-background');
                        img.addEventListener('click', () => {
                            stageArea.style.backgroundImage = `url(${bg.src})`;
                            stageArea.style.backgroundColor = 'transparent';
                            logToConsole(`רקע שונה ל-${bg.alt}`);
                            // הסרת בחירה מכל התמונות והוספה לנוכחית
                            document.querySelectorAll('.recent-background').forEach(i => i.classList.remove('selected'));
                            img.classList.add('selected');
                        });
                        recentBackgroundsContainer.appendChild(img);
                    });
                };

                workspace = Blockly.inject('blockly-area', {
                    toolbox: document.getElementById('toolbox'),
                    scrollbars: true,
                    trashcan: true,
                    rtl: true,
                    zoom: {
                        controls: true,
                        wheel: true,
                        startScale: 1.25,
                        maxScale: 3,
                        minScale: 0.3,
                        scaleSpeed: 1.2
                    },
                    theme: Blockly.Themes.Zelos
                });

                // מפת הבלוקים שהם פותחני תסריטים
                const eventHandlers = {
                    'event_when_flag_clicked': async () => {
                        const code = Blockly.JavaScript.workspaceToCode(workspace);
                        await runCode(code);
                    },
                    'event_when_stage_clicked': async () => {
                        const code = Blockly.JavaScript.workspaceToCode(workspace);
                        await runCode(code);
                    }
                };

                // הוספת בלוקים למרחב העבודה
                const blocks = document.getElementById('toolbox').getElementsByTagName('block');
                for (const block of blocks) {
                    // בדיקת הגנה: ודא שהבלוק קיים ויש לו מאפיין type
                    if (block && block.type && block.type.startsWith('event_')) {
                        const topBlock = workspace.newBlock(block.type);
                        topBlock.initSvg();
                        topBlock.render();
                        topBlock.moveBy(20, 20);
                    }
                }

                const runCode = async (code) => {
                    // בדיקה אם הקוד ריק או מכיל רק רווחים
                    if (!code.trim()) {
                        logToConsole('אין בלוקים בתוכנית. גרור בלוקים כדי להתחיל!');
                        return;
                    }
                    logToConsole('--- הפעלה חדשה ---');
                    try {
                        // הפעלת הקוד בתוך פונקציה אסינכרונית
                        await eval('(async () => {' + code + '})()');
                        logToConsole('הפעלה הסתיימה בהצלחה.');
                    } catch (e) {
                        logToConsole('שגיאה בהפעלת הקוד: ' + e + '. אנא ודא שהבלוקים מחוברים כראוי ושהקוד שלם.');
                    }
                };

                document.getElementById('run-button').addEventListener('click', () => {
                    eventHandlers['event_when_flag_clicked']();
                });

                stageArea.addEventListener('click', (event) => {
                    // ודא שהקליק לא היה על הדמות עצמה
                    if (event.target.id !== 'cat-sprite' && event.target.closest('#cat-sprite') === null) {
                        eventHandlers['event_when_stage_clicked']();
                    }
                });

                document.getElementById('reset-button').addEventListener('click', resetCatPosition);
                
                // אפס את מיקום החתול בעת טעינת הדף
                resetCatPosition();

                fullscreenButton.addEventListener('click', () => {
                    if (!document.fullscreenElement) {
                        containerWrapper.requestFullscreen().catch(err => {
                            logToConsole(`Error attempting to enable full-screen: ${err.message} (${err.name})`);
                        });
                    } else {
                        document.exitFullscreen();
                    }
                });

                // מאזיני אירועים לגלריית הרקעים
                thumbnails.forEach(thumbnail => {
                    thumbnail.addEventListener('click', () => {
                        stageArea.style.backgroundImage = `url(${thumbnail.src})`;
                        stageArea.style.backgroundColor = 'transparent';
                        logToConsole(`רקע שונה ל-${thumbnail.alt}`);
                        // הוספת הרקע לרשימת הרקעים האחרונים
                        updateRecentBackgrounds({ src: thumbnail.src, alt: thumbnail.alt });
                        // סגור את הגלריה
                        backgroundGallery.classList.remove('visible');
                        document.getElementById('gallery-icon').innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />`;
                    });
                });

                // מאזין אירועים לכפתור הפלוס
                toggleGalleryButton.addEventListener('click', () => {
                    const icon = document.getElementById('gallery-icon');
                    if (backgroundGallery.classList.contains('visible')) {
                        backgroundGallery.classList.remove('visible');
                        icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />`;
                    } else {
                        backgroundGallery.classList.add('visible');
                        icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />`;
                    }
                });
            };
        });
    </script>
</body>
</html>
