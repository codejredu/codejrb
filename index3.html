<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> 拽 转</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/blockly@9.0.0/blockly.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .container-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 1rem;
        }
        @media (min-width: 1024px) {
            .container-wrapper {
                flex-direction: row-reverse;
            }
        }
        #stage-area {
            position: relative;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 480px;
            height: 360px;
            flex-shrink: 0;
            margin: 0 auto 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid #ccc;
        }
        @media (min-width: 1024px) {
            #stage-area {
                margin: 0 1rem 0 0;
            }
        }
        #cat-sprite {
            position: absolute;
            width: 80px;
            height: 80px;
            background-color: transparent;
            border-radius: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            transform: translate(0, 0);
            transition: transform 0.1s ease-out; /* 专转 注专 专 转专 专专 */
            z-index: 10;
            opacity: 1;
            cursor: grab; /* 砖 住 注专 专专 */
        }
        #cat-sprite:active {
            cursor: grabbing;
        }
        #cat-sprite img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 0;
        }
        .speech-bubble {
            position: absolute;
            background: #fdfd96;
            border-radius: 12px;
            padding: 8px 12px;
            border: 1px solid #ccc;
            white-space: nowrap;
            font-size: 0.9rem;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .speech-bubble::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 100%;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-top-color: #fdfd96;
            border-bottom: 0;
            margin-left: -8px;
            margin-top: -1px;
        }
        .speech-bubble.visible {
            opacity: 1;
        }
        #blockly-area {
            flex-grow: 1;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: 100%;
        }
        .controls-and-blockly {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        #console-output {
            position: absolute;
            bottom: 4px;
            left: 4px;
            right: 4px;
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 8px;
            font-size: 0.8rem;
            max-height: 80px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="container-wrapper" class="container-wrapper">
        <!-- 专  转 -->
        <div class="flex-1 lg:w-1/2 flex flex-col items-center">
            <h1 class="text-3xl font-bold mb-4 text-center"> 砖 转</h1>
            <div id="stage-area" class="w-full lg:w-auto p-4 flex flex-col justify-center rounded-2xl">
                <div class="relative w-full h-full flex items-center justify-center">
                    <div id="cat-sprite">
                        <img src="https://codejredu.github.io/claudejr/GingerCat.svg" alt="转 ''">
                        <div id="speech-bubble" class="speech-bubble"></div>
                    </div>
                </div>
                <div id="console-output">
                    <b>驻 拽住:</b>
                </div>
            </div>
        </div>

        <!-- 专 拽 驻拽 -->
        <div class="controls-and-blockly w-full mt-4 lg:w-1/2 lg:mt-0">
            <div id="blockly-area" class="h-[calc(100vh-16rem)] lg:h-[calc(100vh-2rem)] w-full rounded-2xl"></div>
            <div class="flex flex-row space-x-2 space-x-reverse justify-center mt-4">
                <button id="run-button" class="px-6 py-3 bg-green-500 text-white font-bold rounded-full shadow-md hover:bg-green-600 transition-colors">
                    <span class="ml-2">驻注</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.127l-3.328 2.378a.999.999 0 01-1.424-.712V8.92c0-.525.53-.787 1.055-.443l3.328 2.378a.999.999 0 01-.031 1.094z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
                <button id="reset-button" class="px-6 py-3 bg-red-500 text-white font-bold rounded-full shadow-md hover:bg-red-600 transition-colors">
                    <span class="ml-2">驻住</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m16.733 11.234A9.975 9.975 0 0112 21c-5.523 0-10-4.477-10-10S6.477 1 12 1s10 4.477 10 10c0 .487-.04.965-.118 1.432m-11.234 3.733l-4 4L4 16m9-13.885v3.424m-4.542 6.556l-3.79-3.79M17.458 12.062L13.668 15.852" />
                    </svg>
                </button>
                <button id="fullscreen-button" class="px-6 py-3 bg-blue-500 text-white font-bold rounded-full shadow-md hover:bg-blue-600 transition-colors">
                    <span class="ml-2">住 </span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m0 0l-5 5m0 5v4m0 0h4m0 0l-5-5m-9 5v4m0 0h-4m0 0l5-5" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <xml id="toolbox" style="display: none">
        <!-- 转驻专 拽 -->
        <category name="专注" colour="#FFD95A">
            <block type="event_when_flag_clicked"></block>
            <block type="event_when_key_pressed"></block>
            <block type="event_when_stage_clicked"></block>
        </category>
        <category name="转注" colour="#4C97FF">
            <block type="motion_move_steps">
                <value name="STEPS">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="motion_turn_right_degrees">
                <value name="DEGREES">
                    <shadow type="math_number">
                        <field name="NUM">15</field>
                    </shadow>
                </value>
            </block>
            <block type="motion_turn_left_degrees">
                <value name="DEGREES">
                    <shadow type="math_number">
                        <field name="NUM">15</field>
                    </shadow>
                </value>
            </block>
            <block type="motion_go_to_xy">
                <value name="X">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
                <value name="Y">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
            </block>
            <block type="motion_glide_to_xy">
                <value name="SECS">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="X">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
                <value name="Y">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="专" colour="#9966FF">
            <block type="looks_say_for_secs">
                <value name="MESSAGE">
                    <shadow type="text">
                        <field name="TEXT">砖!</field>
                    </shadow>
                </value>
                <value name="SECS">
                    <shadow type="math_number">
                        <field name="NUM">2</field>
                    </shadow>
                </value>
            </block>
            <block type="looks_say">
                <value name="MESSAGE">
                    <shadow type="text">
                        <field name="TEXT">砖!</field>
                    </shadow>
                </value>
            </block>
            <block type="looks_show"></block>
            <block type="looks_hide"></block>
            <block type="looks_set_transparency">
                <value name="TRANSPARENCY">
                    <shadow type="math_number">
                        <field name="NUM">50</field>
                    </shadow>
                </value>
            </block>
            <block type="looks_set_sprite">
                <value name="URL">
                    <shadow type="text">
                        <field name="TEXT">https://codejredu.github.io/claudejr/GingerCat.svg</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="拽专" colour="#FF6B1A">
            <block type="control_wait_secs">
                <value name="SECS">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
            <block type="control_repeat_times">
                <value name="TIMES">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
                <statement name="DO">
                    <!-- 拽 驻 -->
                </statement>
            </block>
            <block type="control_forever"></block>
        </category>
        <category name="驻专专" colour="#40BF4A">
            <block type="operator_add"></block>
            <block type="operator_subtract"></block>
            <block type="operator_multiply"></block>
            <block type="operator_divide"></block>
            <block type="operator_random_number">
                <field name="FROM">1</field>
                <field name="TO">10</field>
            </block>
        </category>
    </xml>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const catSprite = document.getElementById('cat-sprite');
            const stageArea = document.getElementById('stage-area');
            const speechBubble = document.getElementById('speech-bubble');
            const consoleOutput = document.getElementById('console-output');
            const containerWrapper = document.getElementById('container-wrapper');
            const fullscreenButton = document.getElementById('fullscreen-button');

            let workspace;
            let currentX = 0;
            let currentY = 0;
            let currentDirection = 90;
            let stageWidth = 0;
            let stageHeight = 0;
            
            // 砖转 注专 专专
            let isDragging = false;
            let initialMouseX;
            let initialMouseY;

            const logToConsole = (message) => {
                const p = document.createElement('p');
                p.textContent = message;
                consoleOutput.appendChild(p);
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            };

            const setSprite = (content) => {
                catSprite.innerHTML = content;
                if (content === '') {
                    catSprite.style.backgroundColor = '#ff9900';
                    catSprite.style.borderRadius = '50%';
                } else {
                    catSprite.style.backgroundColor = 'transparent';
                    catSprite.style.borderRadius = '0';
                }
            };

            const updateStageSize = () => {
                stageWidth = stageArea.clientWidth;
                stageHeight = stageArea.clientHeight;
                // 注 拽 转
                updateCatPosition();
            };

            const updateCatPosition = () => {
                const spriteWidth = catSprite.offsetWidth;
                const spriteHeight = catSprite.offsetHeight;
                const newX = (stageWidth / 2) + currentX - (spriteWidth / 2);
                const newY = (stageHeight / 2) + currentY - (spriteHeight / 2);
                catSprite.style.transform = `translate(${newX}px, ${newY}px) rotate(${currentDirection - 90}deg)`;
            };

            window.addEventListener('resize', updateStageSize);
            updateStageSize();

            // 驻拽爪转 专专 - 转 注专 抓'
            const getPointerPosition = (e) => {
                const isTouch = e.touches && e.touches.length > 0;
                return {
                    x: isTouch ? e.touches[0].clientX : e.clientX,
                    y: isTouch ? e.touches[0].clientY : e.clientY
                };
            };
            
            const startDrag = (e) => {
                e.preventDefault();
                isDragging = true;
                const { x, y } = getPointerPosition(e);
                initialMouseX = x;
                initialMouseY = y;
                catSprite.style.transition = 'none';
                logToConsole('转 转驻住 专专.');
            };

            const drag = (e) => {
                if (isDragging) {
                    const { x, y } = getPointerPosition(e);
                    const deltaX = x - initialMouseX;
                    const deltaY = y - initialMouseY;
                    
                    currentX = currentX + deltaX;
                    currentY = currentY + deltaY;
                    
                    initialMouseX = x;
                    initialMouseY = y;
                    
                    updateCatPosition();
                }
            };

            const endDrag = () => {
                if (isDragging) {
                    isDragging = false;
                    catSprite.style.transition = 'transform 0.5s ease-out';
                    logToConsole(`转 专专 拽 砖 (x: ${currentX.toFixed(2)}, y: ${currentY.toFixed(2)})`);
                }
            };

            //  专注 专专 - 注专 抓'
            catSprite.addEventListener('mousedown', startDrag);
            catSprite.addEventListener('touchstart', startDrag);

            stageArea.addEventListener('mousemove', drag);
            stageArea.addEventListener('touchmove', drag);

            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
            document.addEventListener('touchcancel', endDrag);
            
            // 专转 拽 转 砖转
            Blockly.Blocks['event_when_flag_clicked'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("砖专");
                    this.appendDummyInput()
                        .appendField(new Blockly.FieldImage("https://www.gstatic.com/codesite/ph/images/play_button.gif", 15, 15, { alt: "", flipRtl: "false" }));
                    this.appendDummyInput()
                        .appendField("抓");
                    this.setNextStatement(true, null);
                    this.setColour("#FFD95A");
                    this.setTooltip("转 转 转住专 砖专  专拽 抓.");
                    this.setHelpUrl("");
                }
            };
            Blockly.JavaScript['event_when_flag_clicked'] = function(block) {
                return '';
            };
            Blockly.Blocks['event_when_key_pressed'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("砖专 拽砖")
                        .appendField(new Blockly.FieldDropdown([
                            ["专", "SPACE"],
                            ["抓 注", "UP"],
                            ["抓 ", "DOWN"],
                            ["抓 ", "RIGHT"],
                            ["抓 砖", "LEFT"]
                        ]), "KEY")
                        .appendField("抓");
                    this.setNextStatement(true, null);
                    this.setColour("#FFD95A");
                    this.setTooltip("驻注 拽 砖专 拽砖 抓. (驻拽爪转   转转   转.)");
                    this.setHelpUrl("");
                }
            };
            Blockly.JavaScript['event_when_key_pressed'] = function(block) {
                return '';
            };
            // 拽 砖: 砖专 爪 注 
            Blockly.Blocks['event_when_stage_clicked'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("砖专  爪转");
                    this.setNextStatement(true, null);
                    this.setColour("#FFD95A");
                    this.setTooltip("驻注 转 转住专 砖专 爪 注 专 .");
                    this.setHelpUrl("");
                }
            };
            Blockly.JavaScript['event_when_stage_clicked'] = function(block) {
                return '';
            };

            // 转注
            Blockly.Blocks['motion_move_steps'] = {
                init: function() {
                    this.appendValueInput("STEPS")
                        .setCheck("Number")
                        .appendField("")
                        .appendField("爪注");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#4C97FF");
                    this.setTooltip(" 转 转  砖 驻.");
                }
            };
            Blockly.JavaScript['motion_move_steps'] = function(block) {
                const steps = Blockly.JavaScript.valueToCode(block, 'STEPS', Blockly.JavaScript.ORDER_NONE) || '10';
                const code = `
                    await new Promise(resolve => {
                        const radians = (currentDirection - 90) * Math.PI / 180;
                        const newX = currentX + (${steps} * Math.cos(radians));
                        const newY = currentY + (${steps} * Math.sin(radians));
                        currentX = newX;
                        currentY = newY;
                        updateCatPosition();
                        logToConsole('转  ' + ${steps} + ' 爪注.');
                        setTimeout(resolve, 500);
                    });
                `;
                return code;
            };
            Blockly.Blocks['motion_turn_right_degrees'] = {
                init: function() {
                    this.appendValueInput("DEGREES")
                        .setCheck("Number")
                        .appendField("住转 ")
                        .appendField("注转");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#4C97FF");
                    this.setTooltip("住 转 转 .");
                }
            };
            Blockly.JavaScript['motion_turn_right_degrees'] = function(block) {
                const degrees = Blockly.JavaScript.valueToCode(block, 'DEGREES', Blockly.JavaScript.ORDER_ATOMIC) || '15';
                const code = `
                    await new Promise(resolve => {
                        currentDirection += ${degrees};
                        updateCatPosition();
                        logToConsole('转 住转  -' + ${degrees} + ' 注转.');
                        setTimeout(resolve, 10);
                    });
                `;
                return code;
            };
            Blockly.Blocks['motion_turn_left_degrees'] = {
                init: function() {
                    this.appendValueInput("DEGREES")
                        .setCheck("Number")
                        .appendField("住转 砖")
                        .appendField("注转");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#4C97FF");
                    this.setTooltip("住 转 转 砖.");
                }
            };
            Blockly.JavaScript['motion_turn_left_degrees'] = function(block) {
                const degrees = Blockly.JavaScript.valueToCode(block, 'DEGREES', Blockly.JavaScript.ORDER_ATOMIC) || '15';
                const code = `
                    await new Promise(resolve => {
                        currentDirection -= ${degrees};
                        updateCatPosition();
                        logToConsole('转 住转 砖 -' + ${degrees} + ' 注转.');
                        setTimeout(resolve, 10);
                    });
                `;
                return code;
            };
            Blockly.Blocks['motion_go_to_xy'] = {
                init: function() {
                    this.appendValueInput("X")
                        .setCheck("Number")
                        .appendField("拽驻抓 -x:");
                    this.appendValueInput("Y")
                        .setCheck("Number")
                        .appendField("y:");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#4C97FF");
                    this.setTooltip("拽驻爪 拽 住 注 .");
                }
            };
            Blockly.JavaScript['motion_go_to_xy'] = function(block) {
                const x = Blockly.JavaScript.valueToCode(block, 'X', Blockly.JavaScript.ORDER_ATOMIC) || '0';
                const y = Blockly.JavaScript.valueToCode(block, 'Y', Blockly.JavaScript.ORDER_ATOMIC) || '0';
                const code = `
                    await new Promise(resolve => {
                        currentX = ${x};
                        currentY = ${y};
                        updateCatPosition();
                        logToConsole('拽驻抓 -x: ' + ${x} + ' y: ' + ${y});
                        resolve();
                    });
                `;
                return code;
            };
            Blockly.Blocks['motion_glide_to_xy'] = {
                init: function() {
                    this.appendValueInput("SECS")
                        .setCheck("Number")
                        .appendField("拽")
                        .appendField("砖转");
                    this.appendValueInput("X")
                        .setCheck("Number")
                        .appendField("-x:");
                    this.appendValueInput("Y")
                        .setCheck("Number")
                        .appendField("y:");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#4C97FF");
                    this.setTooltip("拽 转 转 爪专 拽 拽 住.");
                }
            };
            Blockly.JavaScript['motion_glide_to_xy'] = function(block) {
                const secs = Blockly.JavaScript.valueToCode(block, 'SECS', Blockly.JavaScript.ORDER_ATOMIC) || '1';
                const x = Blockly.JavaScript.valueToCode(block, 'X', Blockly.JavaScript.ORDER_ATOMIC) || '0';
                const y = Blockly.JavaScript.valueToCode(block, 'Y', Blockly.JavaScript.ORDER_ATOMIC) || '0';
                const code = `
                    await new Promise(resolve => {
                        catSprite.style.transition = 'transform ' + ${secs} + 's ease-in-out';
                        currentX = ${x};
                        currentY = ${y};
                        updateCatPosition();
                        logToConsole('转 拽 -x: ' + ${x} + ' y: ' + ${y});
                        setTimeout(() => {
                            catSprite.style.transition = 'transform 0.1s ease-out';
                            resolve();
                        }, ${secs} * 1000);
                    });
                `;
                return code;
            };

            // 专
            Blockly.Blocks['looks_say_for_secs'] = {
                init: function() {
                    this.appendValueInput("MESSAGE")
                        .setCheck("String")
                        .appendField("专");
                    this.appendValueInput("SECS")
                        .setCheck("Number")
                        .appendField("砖")
                        .appendField("砖转");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#9966FF");
                    this.setTooltip("爪 注转 专.");
                }
            };
            Blockly.JavaScript['looks_say_for_secs'] = function(block) {
                const message = Blockly.JavaScript.valueToCode(block, 'MESSAGE', Blockly.JavaScript.ORDER_ATOMIC) || '"砖!"';
                const code = `
                    await new Promise(resolve => {
                        speechBubble.textContent = ${message.replace(/'/g, "")};
                        speechBubble.classList.add('visible');
                        logToConsole('专: ' + ${message});
                        setTimeout(() => {
                            speechBubble.classList.remove('visible');
                            resolve();
                        }, ${Blockly.JavaScript.valueToCode(block, 'SECS', Blockly.JavaScript.ORDER_ATOMIC) || '2'} * 1000);
                    });
                `;
                return code;
            };
            Blockly.Blocks['looks_say'] = {
                init: function() {
                    this.appendValueInput("MESSAGE")
                        .setCheck("String")
                        .appendField("专");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#9966FF");
                    this.setTooltip("爪 注转 专.");
                }
            };
            Blockly.JavaScript['looks_say'] = function(block) {
                const message = Blockly.JavaScript.valueToCode(block, 'MESSAGE', Blockly.JavaScript.ORDER_ATOMIC) || '"砖!"';
                const code = `
                    await new Promise(resolve => {
                        speechBubble.textContent = ${message.replace(/'/g, "")};
                        speechBubble.classList.add('visible');
                        logToConsole('专: ' + ${message});
                        resolve();
                    });
                `;
                return code;
            };
            Blockly.Blocks['looks_show'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("爪");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#9966FF");
                    this.setTooltip("爪 转 转.");
                }
            };
            Blockly.JavaScript['looks_show'] = function(block) {
                const code = `
                    await new Promise(resolve => {
                        catSprite.style.display = 'flex';
                        logToConsole('转 驻注.');
                        resolve();
                    });
                `;
                return code;
            };
            Blockly.Blocks['looks_hide'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("住转专");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#9966FF");
                    this.setTooltip("住转专 转 转.");
                }
            };
            Blockly.JavaScript['looks_hide'] = function(block) {
                const code = `
                    await new Promise(resolve => {
                        catSprite.style.display = 'none';
                        logToConsole('转 住转专.');
                        resolve();
                    });
                `;
                return code;
            };
            Blockly.Blocks['looks_set_transparency'] = {
                init: function() {
                    this.appendValueInput("TRANSPARENCY")
                        .setCheck("Number")
                        .appendField("砖 砖拽驻转 -");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#9966FF");
                    this.setTooltip("砖 转 砖拽驻转 转 (0-100).");
                }
            };
            Blockly.JavaScript['looks_set_transparency'] = function(block) {
                const transparency = Blockly.JavaScript.valueToCode(block, 'TRANSPARENCY', Blockly.JavaScript.ORDER_ATOMIC) || '100';
                const code = `
                    await new Promise(resolve => {
                        let opacityValue = Math.max(0, Math.min(1, ${transparency} / 100));
                        catSprite.style.opacity = opacityValue;
                        logToConsole('砖拽驻转 转 砖转 -' + ${transparency} + '%');
                        resolve();
                    });
                `;
                return code;
            };
            Blockly.Blocks['looks_set_sprite'] = {
                init: function() {
                    this.appendValueInput("URL")
                        .setCheck("String")
                        .appendField("砖 转 -SVG 拽砖专");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#9966FF");
                    this.setTooltip("砖 转 专 转 拽抓 SVG 拽砖专.");
                }
            };
            Blockly.JavaScript['looks_set_sprite'] = function(block) {
                const url = Blockly.JavaScript.valueToCode(block, 'URL', Blockly.JavaScript.ORDER_ATOMIC) || '""';
                const code = `
                    await new Promise(resolve => {
                        const svgUrl = ${url};
                        const imgElement = document.createElement('img');
                        imgElement.src = svgUrl;
                        imgElement.onload = () => {
                            catSprite.innerHTML = '';
                            catSprite.style.backgroundColor = 'transparent';
                            catSprite.style.borderRadius = '0';
                            catSprite.appendChild(imgElement);
                            logToConsole('转 砖转 拽抓 SVG.');
                            resolve();
                        };
                        imgElement.onerror = () => {
                            logToConsole('砖 注转 拽抓 SVG 拽砖专.');
                            resolve();
                        };
                    });
                `;
                return code;
            };

            // 拽专
            Blockly.Blocks['control_wait_secs'] = {
                init: function() {
                    this.appendValueInput("SECS")
                        .setCheck("Number")
                        .appendField("转")
                        .appendField("砖转");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#FF6B1A");
                    this.setTooltip("转 住驻专 砖转.");
                }
            };
            Blockly.JavaScript['control_wait_secs'] = function(block) {
                const secs = Blockly.JavaScript.valueToCode(block, 'SECS', Blockly.JavaScript.ORDER_ATOMIC) || '1';
                const code = `
                    await new Promise(resolve => {
                        logToConsole('转 ' + ${secs} + ' 砖转...');
                        setTimeout(resolve, ${secs} * 1000);
                    });
                `;
                return code;
            };
            Blockly.Blocks['control_repeat_times'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("专");
                    this.appendValueInput("TIMES")
                        .setCheck("Number");
                    this.appendDummyInput()
                        .appendField("驻注");
                    this.appendStatementInput("DO")
                        .setCheck(null);
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#FF6B1A");
                    this.setTooltip("专 注 拽 砖驻 住驻专 驻注.");
                }
            };
            Blockly.JavaScript['control_repeat_times'] = function(block) {
                const times = Blockly.JavaScript.valueToCode(block, 'TIMES', Blockly.JavaScript.ORDER_ATOMIC) || '10';
                const doCode = Blockly.JavaScript.statementToCode(block, 'DO');
                const code = `
                    logToConsole('转 专 注 ' + ${times} + ' 驻注.');
                    for (let i = 0; i < ${times}; i++) {
                        await (async () => {
                            ${doCode}
                        })();
                    }
                `;
                return code;
            };
            Blockly.Blocks['control_forever'] = {
                init: function() {
                    this.appendDummyInput().appendField("注");
                    this.appendStatementInput("DO").setCheck(null);
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#FF6B1A");
                    this.setTooltip("专 注 拽  驻住拽. (注砖 转拽注 - 砖 砖转砖 专转)");
                }
            };
            Blockly.JavaScript['control_forever'] = function(block) {
                const doCode = Blockly.JavaScript.statementToCode(block, 'DO');
                const code = `
                    logToConsole('转 转 爪...');
                    while(true) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                        await (async () => {
                            ${doCode}
                        })();
                    }
                `;
                return code;
            };

            // 驻专专
            Blockly.Blocks['operator_add'] = {
                init: function() {
                    this.appendValueInput("NUM1").setCheck("Number");
                    this.appendValueInput("NUM2").setCheck("Number").appendField("+");
                    this.setOutput(true, "Number");
                    this.setColour("#40BF4A");
                    this.setTooltip("专 砖 住驻专.");
                }
            };
            Blockly.JavaScript['operator_add'] = function(block) {
                const num1 = Blockly.JavaScript.valueToCode(block, 'NUM1', Blockly.JavaScript.ORDER_ADDITION) || '0';
                const num2 = Blockly.JavaScript.valueToCode(block, 'NUM2', Blockly.JavaScript.ORDER_ADDITION) || '0';
                const code = `(${num1} + ${num2})`;
                return [code, Blockly.JavaScript.ORDER_ADDITION];
            };
            Blockly.Blocks['operator_subtract'] = {
                init: function() {
                    this.appendValueInput("NUM1").setCheck("Number");
                    this.appendValueInput("NUM2").setCheck("Number").appendField("-");
                    this.setOutput(true, "Number");
                    this.setColour("#40BF4A");
                    this.setTooltip("住专 砖 住驻专.");
                }
            };
            Blockly.JavaScript['operator_subtract'] = function(block) {
                const num1 = Blockly.JavaScript.valueToCode(block, 'NUM1', Blockly.JavaScript.ORDER_SUBTRACTION) || '0';
                const num2 = Blockly.JavaScript.valueToCode(block, 'NUM2', Blockly.JavaScript.ORDER_SUBTRACTION) || '0';
                const code = `(${num1} - ${num2})`;
                return [code, Blockly.JavaScript.ORDER_SUBTRACTION];
            };
            Blockly.Blocks['operator_multiply'] = {
                init: function() {
                    this.appendValueInput("NUM1").setCheck("Number");
                    this.appendValueInput("NUM2").setCheck("Number").appendField("");
                    this.setOutput(true, "Number");
                    this.setColour("#40BF4A");
                    this.setTooltip("驻 砖 住驻专.");
                }
            };
            Blockly.JavaScript['operator_multiply'] = function(block) {
                const num1 = Blockly.JavaScript.valueToCode(block, 'NUM1', Blockly.JavaScript.ORDER_MULTIPLICATION) || '0';
                const num2 = Blockly.JavaScript.valueToCode(block, 'NUM2', Blockly.JavaScript.ORDER_MULTIPLICATION) || '0';
                const code = `(${num1} * ${num2})`;
                return [code, Blockly.JavaScript.ORDER_MULTIPLICATION];
            };
            Blockly.Blocks['operator_divide'] = {
                init: function() {
                    this.appendValueInput("NUM1").setCheck("Number");
                    this.appendValueInput("NUM2").setCheck("Number").appendField("梅");
                    this.setOutput(true, "Number");
                    this.setColour("#40BF4A");
                    this.setTooltip("拽 砖 住驻专.");
                }
            };
            Blockly.JavaScript['operator_divide'] = function(block) {
                const num1 = Blockly.JavaScript.valueToCode(block, 'NUM1', Blockly.JavaScript.ORDER_DIVISION) || '0';
                const num2 = Blockly.JavaScript.valueToCode(block, 'NUM2', Blockly.JavaScript.ORDER_DIVISION) || '0';
                const code = `(${num1} / ${num2})`;
                return [code, Blockly.JavaScript.ORDER_DIVISION];
            };
            Blockly.Blocks['operator_random_number'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("专 住驻专 拽专 -")
                        .appendField(new Blockly.FieldTextInput("1"), "FROM")
                        .appendField("注")
                        .appendField(new Blockly.FieldTextInput("10"), "TO");
                    this.setOutput(true, "Number");
                    this.setColour("#40BF4A");
                    this.setTooltip("专 住驻专 拽专  砖爪.");
                }
            };
            Blockly.JavaScript['operator_random_number'] = function(block) {
                const from = block.getFieldValue('FROM');
                const to = block.getFieldValue('TO');
                const code = `Math.floor(Math.random() * (${to} - ${from} + 1)) + ${from}`;
                return [code, Blockly.JavaScript.ORDER_FUNCTION_CALL];
            };

            workspace = Blockly.inject('blockly-area', {
                toolbox: document.getElementById('toolbox'),
                scrollbars: true,
                trashcan: true,
                rtl: true,
                zoom: {
                    controls: true,
                    wheel: true,
                    startScale: 1.25,
                    maxScale: 3,
                    minScale: 0.3,
                    scaleSpeed: 1.2
                },
                theme: Blockly.Themes.Zelos
            });

            // 驻转 拽 砖 驻转 转住专
            const eventHandlers = {
                'event_when_flag_clicked': async () => {
                    const code = Blockly.JavaScript.workspaceToCode(workspace);
                    await runCode(code);
                },
                'event_when_stage_clicked': async () => {
                    const code = Blockly.JavaScript.workspaceToCode(workspace);
                    await runCode(code);
                }
            };

            // 住驻转 拽 专 注
            const blocks = document.getElementById('toolbox').getElementsByTagName('block');
            for (const block of blocks) {
                // 拽转 :  砖拽 拽 砖  驻 type
                if (block && block.type && block.type.startsWith('event_')) {
                    const topBlock = workspace.newBlock(block.type);
                    topBlock.initSvg();
                    topBlock.render();
                    topBlock.moveBy(20, 20);
                }
            }

            const runCode = async (code) => {
                // 拽  拽 专拽   专拽 专
                if (!code.trim()) {
                    logToConsole(' 拽 转转. 专专 拽  转!');
                    return;
                }
                logToConsole('--- 驻注 砖 ---');
                try {
                    // 驻注转 拽 转 驻拽爪 住专转
                    await eval('(async () => {' + code + '})()');
                    logToConsole('驻注 住转 爪.');
                } catch (e) {
                    logToConsole('砖 驻注转 拽: ' + e + '.   砖拽 专 专 砖拽 砖.');
                }
            };

            document.getElementById('run-button').addEventListener('click', () => {
                eventHandlers['event_when_flag_clicked']();
            });

            stageArea.addEventListener('click', (event) => {
                //  砖拽拽   注 转 注爪
                if (event.target.id !== 'cat-sprite' && event.target.closest('#cat-sprite') === null) {
                    eventHandlers['event_when_stage_clicked']();
                }
            });

            document.getElementById('reset-button').addEventListener('click', () => {
                currentX = 0;
                currentY = 0;
                currentDirection = 90;
                updateCatPosition();
                catSprite.style.opacity = 1;
                speechBubble.classList.remove('visible');
                consoleOutput.innerHTML = '<b>驻 拽住:</b>';
                const imgElement = document.createElement('img');
                imgElement.src = 'https://codejredu.github.io/claudejr/GingerCat.svg';
                catSprite.innerHTML = '';
                catSprite.appendChild(imgElement);
                logToConsole(' 驻住.');
            });

            fullscreenButton.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    containerWrapper.requestFullscreen().catch(err => {
                        logToConsole(`Error attempting to enable full-screen: ${err.message} (${err.name})`);
                    });
                } else {
                    document.exitFullscreen();
                }
            });

        });
    </script>
</body>
</html>
