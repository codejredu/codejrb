<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בלוקלי: תצוגת מיקום הדמות</title>
    <!-- הוספת תגית CSP כדי לאפשר טעינת סקריפטים חיצוניים -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdn.tailwindcss.com; img-src 'self' data: https:;"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/blockly@9.0.0/blockly.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .container-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 1rem;
        }
        @media (min-width: 1024px) {
            .container-wrapper {
                flex-direction: row-reverse;
            }
        }
        /* עטיפה חדשה לבמה, אזורים ולגלריה */
        #stage-and-sections-wrapper {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            margin: 0 auto 1rem;
            max-height: 100vh;
        }
        @media (min-width: 1024px) {
            #stage-and-sections-wrapper {
                margin: 0 1rem 0 0;
            }
        }
        /* עטיפה שתשמור על יחס הגובה-רוחב */
        #stage-aspect-ratio-wrapper {
            position: relative;
            width: 100%;
            padding-top: 75%;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: #fff;
            border: 2px solid #ccc;
            margin-bottom: 1rem;
        }
        #stage-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            border-radius: 12px;
        }
        .sprite-wrapper {
            position: absolute;
            width: 80px;
            height: 80px;
            background-color: transparent;
            border-radius: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            transform: translate(calc(-50% + 0px), calc(-50% + 0px));
            transition: transform 0.1s ease-out;
            z-index: 10;
            opacity: 1;
            cursor: grab;
        }
        .sprite-wrapper:active {
            cursor: grabbing;
        }
        .sprite-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 0;
        }
        .speech-bubble {
            position: absolute;
            background: #fdfd96;
            border-radius: 12px;
            padding: 8px 12px;
            border: 1px solid #ccc;
            white-space: nowrap;
            font-size: 0.9rem;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .speech-bubble::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 100%;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-top-color: #fdfd96;
            border-bottom: 0;
            margin-left: -8px;
            margin-top: -1px;
        }
        .speech-bubble.visible {
            opacity: 1;
        }
        .coordinates-display {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-family: monospace;
            z-index: 20;
            direction: ltr; /* Ensure LTR for numbers */
        }
        .controls-and-blockly {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }
        #blockly-area {
            flex-grow: 1;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: 100%;
        }
        /* אזורים חדשים */
        .section {
            background-color: #fff;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #ccc;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .section-header h2 {
            font-size: 1.25rem;
            font-weight: bold;
        }
        .plus-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #4C97FF;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .section-content {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }
        .sprite-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 0.5rem;
            cursor: pointer;
            transition: border-color 0.2s;
            position: relative;
        }
        .sprite-card.selected {
            border-color: #4C97FF;
        }
        .sprite-card img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 8px;
        }
        .delete-button {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            cursor: pointer;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .sprite-card:hover .delete-button {
            visibility: visible;
            opacity: 1;
        }
        .backdrop-card {
            width: 80px;
            height: 60px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            transition: border-color 0.2s;
        }
        .backdrop-card.selected {
            border-color: #4C97FF;
        }
        .gallery-container {
            width: 100%;
            padding: 1rem;
            background-color: #f0f4f8;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: none;
            transition: all 0.5s ease-in-out;
            border: 2px solid #ccc;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 20;
            height: 100%;
            overflow-y: auto;
        }
        .gallery-container.visible {
            display: block;
        }
        .thumbnail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
        }
        .thumbnail {
            width: 100%;
            height: auto;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .thumbnail.selected {
            border: 3px solid #4C97FF;
        }
        .close-gallery-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: #ccc;
            color: #333;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="container-wrapper" class="container-wrapper">
        <!-- אזור הבמה, הדמויות והרקעים -->
        <div class="flex-1 lg:w-1/2 flex flex-col" id="stage-and-sections-wrapper">
            <h1 class="text-3xl font-bold mb-4 text-center">במה של החתול</h1>
            <div id="stage-aspect-ratio-wrapper" class="w-full relative">
                <div id="stage-area">
                    <div id="coords-display" class="coordinates-display">X: 0, Y: 0</div>
                </div>
                <!-- גלריית רקעים נפתחת מעל הבמה -->
                <div id="background-gallery" class="gallery-container">
                    <button class="close-gallery-button" id="close-gallery-button">X</button>
                    <h2 class="text-xl font-bold text-center mb-4">גלריית רקעים</h2>
                    <div id="thumbnails-grid" class="thumbnail-grid">
                        <img src="https://codejredu.github.io/test/assets/bg/Amphitheater.svg" alt="Amphitheater" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/canyon.svg" alt="canyon" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/canyon1.svg" alt="canyon1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/castel.svg" alt="castel" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/castel1.svg" alt="castel1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/citynight.svg" alt="citynight" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/citynight2.svg" alt="citynight2" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/colorfulcity.svg" alt="colorfulcity" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/colorfulcity1.svg" alt="colorfulcity1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/desert.svg" alt="desert" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/desert1.svg" alt="desert1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/farm.svg" alt="farm" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/kidbadroom.svg" alt="kidbadroom" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/kidbadroom1.svg" alt="kidbadroom1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/moon.svg" alt="moon" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/road1.svg" alt="road1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/road2.svg" alt="road2" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/room1.svg" alt="room1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/room2.svg" alt="room2" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/savanna1.svg" alt="savanna1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/savanna2.svg" alt="savanna2" class="thumbnail">
                        <img src="https://codejredu.github.io/test/test/assets/bg/school1.svg" alt="school1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/slopes1.svg" alt="slopes1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/slopes2.svg" alt="slopes2" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/soccer1.svg" alt="soccer1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/soccer2.svg" alt="soccer2" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/winter1.svg" alt="winter1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/winter2.svg" alt="winter2" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/under.svg" alt="under" class="thumbnail">
                    </div>
                </div>
            </div>

            <!-- אזור הדמויות -->
            <div class="section">
                <div class="section-header">
                    <h2>דמויות</h2>
                    <div id="add-sprite-button" class="plus-button">+</div>
                </div>
                <div id="sprites-list" class="section-content">
                    <!-- כאן יוצגו הדמויות -->
                </div>
            </div>

            <!-- אזור הצלילים -->
            <div class="section">
                <div class="section-header">
                    <h2>צלילים</h2>
                    <div id="add-sound-button" class="plus-button">+</div>
                </div>
                <div id="sounds-list" class="section-content">
                    <!-- כאן יוצגו הצלילים -->
                    <div class="sound-card">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-12 h-12 text-gray-500">
                            <path d="M13.5 4.5a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM12 18.75a7.5 7.5 0 00-4.721-6.766L7.5 12h-.779c-2.15 0-4.14-1.285-5.328-3.359.18-.553.77-.959 1.488-.959h11.15c.718 0 1.307.406 1.487.96-.282.525-.43 1.11-.429 1.704a4.496 4.496 0 01-1.298 3.163A6.096 6.096 0 0012 18.75z"/>
                            <path fill-rule="evenodd" d="M19.303 7.643a.75.75 0 111.061 1.061l-3.385 3.384a.75.75 0 01-1.061-1.06l3.385-3.386zM15.918 2.628a.75.75 0 01.993 1.121C15.612 4.605 14.218 6 12.5 6a.75.75 0 010-1.5c1.474 0 2.806-1.139 3.593-2.628z" clip-rule="evenodd"/>
                        </svg>
                        <span class="text-sm mt-1">צליל ברירת מחדל</span>
                    </div>
                </div>
            </div>

            <!-- אזור הרקעים -->
            <div class="section">
                <div class="section-header">
                    <h2>רקעים</h2>
                    <div id="add-backdrop-button" class="plus-button">+</div>
                </div>
                <div id="backdrops-list" class="section-content">
                    <!-- כאן יוצגו הרקעים -->
                </div>
            </div>
        </div>

        <!-- אזור הבלוקלי והפקדים -->
        <div class="controls-and-blockly w-full mt-4 lg:w-1/2 lg:mt-0">
            <div id="blockly-area" class="h-[calc(100vh-16rem)] lg:h-[calc(100vh-2rem)] w-full rounded-2xl"></div>
            <div class="flex flex-row space-x-2 space-x-reverse justify-center mt-4">
                <button id="run-button" class="px-6 py-3 bg-green-500 text-white font-bold rounded-full shadow-md hover:bg-green-600 transition-colors">
                    <span class="ml-2">הפעל</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.127l-3.328 2.378a.999.999 0 01-1.424-.712V8.92c0-.525.53-.787 1.055-.443l3.328 2.378a.999.999 0 01-.031 1.094z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
                <button id="reset-button" class="px-6 py-3 bg-red-500 text-white font-bold rounded-full shadow-md hover:bg-red-600 transition-colors">
                    <span class="ml-2">אפס</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m16.733 11.234A9.975 9.975 0 0112 21c-5.523 0-10-4.477-10-10S6.477 1 12 1s10 4.477 10 10c0 .487-.04.965-.118 1.432m-11.234 3.733l-4 4L4 16m9-13.885v3.424m-4.542 6.556l-3.79-3.79M17.458 12.062L13.668 15.852" />
                    </svg>
                </button>
                <button id="fullscreen-button" class="px-6 py-3 bg-blue-500 text-white font-bold rounded-full shadow-md hover:bg-blue-600 transition-colors">
                    <span class="ml-2">מסך מלא</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m0 0l-5 5m0 5v4m0 0h4m0 0l-5-5m-9 5v4m0 0h-4m0 0l5-5" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <xml id="toolbox" style="display: none">
        <!-- תפריט הבלוקים -->
        <category name="אירועים" colour="#FFD95A">
            <block type="event_when_flag_clicked"></block>
            <block type="event_when_stage_clicked"></block>
            <block type="event_when_key_pressed"></block>
        </category>
        <category name="תנועה" colour="#4C97FF">
            <block type="motion_move_steps">
                <value name="STEPS">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="motion_turn_right_degrees">
                <value name="DEGREES">
                    <shadow type="math_number">
                        <field name="NUM">15</field>
                    </shadow>
                </value>
            </block>
            <block type="motion_turn_left_degrees">
                <value name="DEGREES">
                    <shadow type="math_number">
                        <field name="NUM">15</field>
                    </shadow>
                </value>
            </block>
            <block type="motion_set_direction">
                <field name="DEGREES">90</field>
            </block>
            <block type="motion_go_to_xy">
                <value name="X">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
                <value name="Y">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
            </block>
            <block type="motion_glide_to_xy">
                <value name="SECS">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="X">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
                <value name="Y">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
            </block>
            <block type="motion_x_position"></block>
            <block type="motion_y_position"></block>
        </category>
        <category name="מראה" colour="#9966FF">
            <block type="looks_say_for_secs">
                <value name="MESSAGE">
                    <shadow type="text">
                        <field name="TEXT">שלום!</field>
                    </shadow>
                </value>
                <value name="SECS">
                    <shadow type="math_number">
                        <field name="NUM">2</field>
                    </shadow>
                </value>
            </block>
            <block type="looks_say">
                <value name="MESSAGE">
                    <shadow type="text">
                        <field name="TEXT">שלום!</field>
                    </shadow>
                </value>
            </block>
            <block type="looks_show"></block>
            <block type="looks_hide"></block>
            <block type="looks_set_transparency">
                <value name="TRANSPARENCY">
                    <shadow type="math_number">
                        <field name="NUM">50</field>
                    </shadow>
                </value>
            </block>
            <block type="looks_set_sprite">
                <value name="URL">
                    <shadow type="text">
                        <field name="TEXT">https://codejredu.github.io/claudejr/GingerCat.svg</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="בקרה" colour="#FF6B1A">
            <block type="control_wait_secs">
                <value name="SECS">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
            <block type="control_repeat_times">
                <value name="TIMES">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="control_forever"></block>
        </category>
        <category name="אופרטורים" colour="#40BF4A">
            <block type="operator_add"></block>
            <block type="operator_subtract"></block>
            <block type="operator_multiply"></block>
            <block type="operator_divide"></block>
            <block type="operator_random_number">
                <field name="FROM">1</field>
                <field name="TO">10</field>
            </block>
        </category>
    </xml>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const stageArea = document.getElementById('stage-area');
            const coordsDisplay = document.getElementById('coords-display');
            const containerWrapper = document.getElementById('container-wrapper');
            const fullscreenButton = document.getElementById('fullscreen-button');
            const addSpriteButton = document.getElementById('add-sprite-button');
            const spritesList = document.getElementById('sprites-list');
            const addBackdropButton = document.getElementById('add-backdrop-button');
            const backdropsList = document.getElementById('backdrops-list');
            const backgroundGallery = document.getElementById('background-gallery');
            const closeGalleryButton = document.getElementById('close-gallery-button');
            const thumbnailsGrid = document.getElementById('thumbnails-grid');

            const STAGE_WIDTH = 480;
            const STAGE_HEIGHT = 360;

            let workspace;
            let activeSprite = null; // דמות פעילה
            
            const log = (message) => {
                console.log(message);
            };

            const updateCoordsDisplay = (sprite) => {
                if (sprite && sprite.dataset.stageX && sprite.dataset.stageY) {
                    const x = parseFloat(sprite.dataset.stageX).toFixed(0);
                    const y = parseFloat(sprite.dataset.stageY).toFixed(0);
                    coordsDisplay.textContent = `X: ${x}, Y: ${y}`;
                } else {
                    coordsDisplay.textContent = `X: 0, Y: 0`;
                }
            };
            
            const createNewSprite = (name, imageUrl,
                initialX = 0, initialY = 0) => {
                const sprite = document.createElement('div');
                sprite.className = 'sprite-wrapper';
                sprite.id = `sprite-${Date.now()}`;
                
                sprite.dataset.stageX = initialX;
                sprite.dataset.stageY = initialY;
                sprite.dataset.direction = 90; // Default direction

                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = name;

                const speechBubbleElement = document.createElement('div');
                speechBubbleElement.className = 'speech-bubble';

                sprite.appendChild(img);
                sprite.appendChild(speechBubbleElement);
                stageArea.appendChild(sprite);
                
                // הוספת הדמות לרשימה בצד
                const spriteCard = document.createElement('div');
                spriteCard.className = 'sprite-card';
                spriteCard.innerHTML = `<img src="${imageUrl}" alt="${name}"><span>${name}</span><button class="delete-button">X</button>`;
                spriteCard.id = `card-${sprite.id}`;
                spritesList.appendChild(spriteCard);

                const deleteButton = spriteCard.querySelector('.delete-button');
                deleteButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sprite.remove();
                    spriteCard.remove();
                    if (activeSprite === sprite) {
                        activeSprite = null;
                        if (workspace) {
                            workspace.clear();
                        }
                    }
                });

                // הגדרת הדמות כפעילה בלחיצה
                spriteCard.addEventListener('click', () => {
                    setActiveSprite(sprite);
                });

                // הגדרת מיקום התחלתי
                const x = initialX / (STAGE_WIDTH / 2) * (stageArea.clientWidth / 2);
                const y = -1 * (initialY / (STAGE_HEIGHT / 2) * (stageArea.clientHeight / 2));
                sprite.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;

                // הוספת יכולת גרירה
                let isDragging = false;
                let offsetX, offsetY;
                
                sprite.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    isDragging = true;
                    offsetX = e.clientX - sprite.getBoundingClientRect().left;
                    offsetY = e.clientY - sprite.getBoundingClientRect().top;
                    sprite.style.transition = 'none'; // ביטול מעבר בזמן גרירה
                    sprite.style.cursor = 'grabbing'; // שינוי סמן בזמן גרירה
                    setActiveSprite(sprite);
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        const newX = e.clientX - stageArea.getBoundingClientRect().left - offsetX + sprite.getBoundingClientRect().width / 2;
                        const newY = e.clientY - stageArea.getBoundingClientRect().top - offsetY + sprite.getBoundingClientRect().height / 2;
                        
                        // עדכון מיקום בפיקסלים יחסיים לבמה
                        const newStageX = (newX / stageArea.clientWidth) * STAGE_WIDTH - STAGE_WIDTH / 2;
                        const newStageY = -((newY / stageArea.clientHeight) * STAGE_HEIGHT - STAGE_HEIGHT / 2);
                        
                        // שמירת המיקום בנתונים
                        sprite.dataset.stageX = newStageX;
                        sprite.dataset.stageY = newStageY;

                        // עדכון הטרנספורמציה של ה-CSS
                        const cssX = (newStageX / (STAGE_WIDTH / 2)) * (stageArea.clientWidth / 2);
                        const cssY = -1 * (newStageY / (STAGE_HEIGHT / 2)) * (stageArea.clientHeight / 2);

                        sprite.style.transform = `translate(calc(-50% + ${cssX}px), calc(-50% + ${cssY}px))`;
                        updateCoordsDisplay(sprite);
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        sprite.style.transition = 'transform 0.1s ease-out';
                        sprite.style.cursor = 'grab';
                    }
                });

                // הוספת יכולת גרירה בטאצ' (מובייל)
                sprite.addEventListener('touchstart', (e) => {
                    e.stopPropagation();
                    isDragging = true;
                    const touch = e.touches[0];
                    offsetX = touch.clientX - sprite.getBoundingClientRect().left;
                    offsetY = touch.clientY - sprite.getBoundingClientRect().top;
                    sprite.style.transition = 'none';
                    setActiveSprite(sprite);
                });

                document.addEventListener('touchmove', (e) => {
                    if (isDragging) {
                        const touch = e.touches[0];
                        const newX = touch.clientX - stageArea.getBoundingClientRect().left - offsetX + sprite.getBoundingClientRect().width / 2;
                        const newY = touch.clientY - stageArea.getBoundingClientRect().top - offsetY + sprite.getBoundingClientRect().height / 2;
                        
                        // עדכון מיקום בפיקסלים יחסיים לבמה
                        const newStageX = (newX / stageArea.clientWidth) * STAGE_WIDTH - STAGE_WIDTH / 2;
                        const newStageY = -((newY / stageArea.clientHeight) * STAGE_HEIGHT - STAGE_HEIGHT / 2);

                        // שמירת המיקום בנתונים
                        sprite.dataset.stageX = newStageX;
                        sprite.dataset.stageY = newStageY;
                        
                        const cssX = (newStageX / (STAGE_WIDTH / 2)) * (stageArea.clientWidth / 2);
                        const cssY = -1 * (newStageY / (STAGE_HEIGHT / 2)) * (stageArea.clientHeight / 2);

                        sprite.style.transform = `translate(calc(-50% + ${cssX}px), calc(-50% + ${cssY}px))`;
                        updateCoordsDisplay(sprite);
                    }
                });

                document.addEventListener('touchend', () => {
                    isDragging = false;
                    sprite.style.transition = 'transform 0.1s ease-out';
                });
                
                return sprite;
            };

            const setActiveSprite = (spriteElement) => {
                if (activeSprite) {
                    activeSprite.style.border = 'none';
                    document.getElementById(`card-${activeSprite.id}`).classList.remove('selected');
                }
                activeSprite = spriteElement;
                activeSprite.style.border = '2px solid #4C97FF';
                document.getElementById(`card-${activeSprite.id}`).classList.add('selected');
                updateCoordsDisplay(activeSprite);

                if (workspace) {
                    // טען את הבלוקים של הדמות הפעילה
                    const savedXml = spriteElement.dataset.blocklyXml;
                    if (savedXml) {
                        try {
                            const xml = Blockly.utils.xml.textToDom(savedXml);
                            Blockly.Xml.clearWorkspaceAndLoad(xml, workspace);
                        } catch (e) {
                            console.error('Failed to load blocks for sprite:', e);
                            workspace.clear();
                        }
                    } else {
                        workspace.clear();
                    }
                }
            };

            const saveActiveSpriteBlocks = () => {
                if (activeSprite && workspace) {
                    const xml = Blockly.Xml.workspaceToDom(workspace);
                    const xmlText = Blockly.Xml.domToText(xml);
                    activeSprite.dataset.blocklyXml = xmlText;
                }
            };

            const showSpeechBubble = (sprite, message, secs) => {
                const speechBubbleElement = sprite.querySelector('.speech-bubble');
                speechBubbleElement.textContent = message;
                speechBubbleElement.classList.add('visible');
                if (secs > 0) {
                    setTimeout(() => {
                        speechBubbleElement.classList.remove('visible');
                    }, secs * 1000);
                }
            };

            const changeDirection = (sprite, angle) => {
                let currentDirection = parseFloat(sprite.dataset.direction);
                let newDirection = (currentDirection + angle) % 360;
                sprite.dataset.direction = newDirection;
                sprite.style.transform = `translate(calc(-50% + ${sprite.style.left}), calc(-50% + ${sprite.style.top})) rotate(${newDirection - 90}deg)`;
            };

            // הגדרת בלוקים מותאמים אישית
            Blockly.Blocks['event_when_flag_clicked'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("כאשר לוחצים על");
                    this.appendDummyInput()
                        .appendField(new Blockly.FieldImage("https://codejredu.github.io/claudejr/Green_flag.svg", 24, 24, "flag"));
                    this.setNextStatement(true, null);
                    this.setColour('#FFD95A');
                    this.setTooltip("Starts the script when the green flag is clicked.");
                }
            };
            Blockly.JavaScript['event_when_flag_clicked'] = function(block) {
                return 'runCode();';
            };

            Blockly.Blocks['event_when_stage_clicked'] = {
                init: function() {
                    this.appendDummyInput().appendField("כאשר לוחצים על הבמה");
                    this.setNextStatement(true, null);
                    this.setColour('#FFD95A');
                    this.setTooltip("Starts the script when the stage is clicked.");
                }
            };
            Blockly.JavaScript['event_when_stage_clicked'] = function(block) {
                return 'runOnStageClick();';
            };

            Blockly.Blocks['event_when_key_pressed'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("כאשר מקש")
                        .appendField(new Blockly.FieldDropdown([
                            ["space", "space"],
                            ["up arrow", "ArrowUp"],
                            ["down arrow", "ArrowDown"],
                            ["right arrow", "ArrowRight"],
                            ["left arrow", "ArrowLeft"],
                            ["a", "a"],
                            ["b", "b"],
                            ["c", "c"]
                        ]), "KEY")
                        .appendField("נלחץ");
                    this.setNextStatement(true, null);
                    this.setColour('#FFD95A');
                    this.setTooltip("Starts the script when a key is pressed.");
                }
            };
            Blockly.JavaScript['event_when_key_pressed'] = function(block) {
                const key = block.getFieldValue('KEY');
                return `runOnKeyPress('${key}');`;
            };

            Blockly.Blocks['motion_move_steps'] = {
                init: function() {
                    this.appendValueInput("STEPS")
                        .setCheck("Number")
                        .appendField("זוז");
                    this.appendDummyInput()
                        .appendField("צעדים");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#4C97FF');
                    this.setTooltip("Moves the sprite forward by a number of steps.");
                }
            };
            Blockly.JavaScript['motion_move_steps'] = function(block) {
                const steps = Blockly.JavaScript.valueToCode(block, 'STEPS', Blockly.JavaScript.ORDER_NONE) || '0';
                return `moveSteps(${steps});\n`;
            };

            Blockly.Blocks['motion_turn_right_degrees'] = {
                init: function() {
                    this.appendValueInput("DEGREES")
                        .setCheck("Number")
                        .appendField("הסתובב ימינה");
                    this.appendDummyInput()
                        .appendField("מעלות");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#4C97FF');
                    this.setTooltip("Turns the sprite clockwise by a number of degrees.");
                }
            };
            Blockly.JavaScript['motion_turn_right_degrees'] = function(block) {
                const degrees = Blockly.JavaScript.valueToCode(block, 'DEGREES', Blockly.JavaScript.ORDER_NONE) || '0';
                return `turnRight(${degrees});\n`;
            };

            Blockly.Blocks['motion_turn_left_degrees'] = {
                init: function() {
                    this.appendValueInput("DEGREES")
                        .setCheck("Number")
                        .appendField("הסתובב שמאלה");
                    this.appendDummyInput()
                        .appendField("מעלות");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#4C97FF');
                    this.setTooltip("Turns the sprite counter-clockwise by a number of degrees.");
                }
            };
            Blockly.JavaScript['motion_turn_left_degrees'] = function(block) {
                const degrees = Blockly.JavaScript.valueToCode(block, 'DEGREES', Blockly.JavaScript.ORDER_NONE) || '0';
                return `turnLeft(${degrees});\n`;
            };

            Blockly.Blocks['motion_set_direction'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("קבע כיוון ל-")
                        .appendField(new Blockly.FieldAngle("90"), "DEGREES");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#4C97FF');
                    this.setTooltip("Sets the direction of the sprite.");
                }
            };
            Blockly.JavaScript['motion_set_direction'] = function(block) {
                const degrees = block.getFieldValue('DEGREES');
                return `setDirection(${degrees});\n`;
            };

            Blockly.Blocks['motion_go_to_xy'] = {
                init: function() {
                    this.appendValueInput("X")
                        .setCheck("Number")
                        .appendField("עבור ל-X:");
                    this.appendValueInput("Y")
                        .setCheck("Number")
                        .appendField("Y:");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#4C97FF');
                    this.setTooltip("Go to a specific X and Y position.");
                }
            };
            Blockly.JavaScript['motion_go_to_xy'] = function(block) {
                const x = Blockly.JavaScript.valueToCode(block, 'X', Blockly.JavaScript.ORDER_NONE) || '0';
                const y = Blockly.JavaScript.valueToCode(block, 'Y', Blockly.JavaScript.ORDER_NONE) || '0';
                return `goToXY(${x}, ${y});\n`;
            };

            Blockly.Blocks['motion_glide_to_xy'] = {
                init: function() {
                    this.appendValueInput("SECS")
                        .setCheck("Number")
                        .appendField("גלוש במשך");
                    this.appendDummyInput()
                        .appendField("שניות ל-X:");
                    this.appendValueInput("X")
                        .setCheck("Number");
                    this.appendValueInput("Y")
                        .setCheck("Number")
                        .appendField("Y:");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#4C97FF');
                    this.setTooltip("Glides to a specific X and Y position over a period of time.");
                }
            };
            Blockly.JavaScript['motion_glide_to_xy'] = function(block) {
                const secs = Blockly.JavaScript.valueToCode(block, 'SECS', Blockly.JavaScript.ORDER_NONE) || '0';
                const x = Blockly.JavaScript.valueToCode(block, 'X', Blockly.JavaScript.ORDER_NONE) || '0';
                const y = Blockly.JavaScript.valueToCode(block, 'Y', Blockly.JavaScript.ORDER_NONE) || '0';
                return `glideToXY(${secs}, ${x}, ${y});\n`;
            };

            Blockly.Blocks['motion_x_position'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("מיקום X");
                    this.setOutput(true, "Number");
                    this.setColour('#4C97FF');
                    this.setTooltip("The X position of the sprite.");
                }
            };
            Blockly.JavaScript['motion_x_position'] = function(block) {
                return ['getSpriteX()', Blockly.JavaScript.ORDER_ATOMIC];
            };

            Blockly.Blocks['motion_y_position'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("מיקום Y");
                    this.setOutput(true, "Number");
                    this.setColour('#4C97FF');
                    this.setTooltip("The Y position of the sprite.");
                }
            };
            Blockly.JavaScript['motion_y_position'] = function(block) {
                return ['getSpriteY()', Blockly.JavaScript.ORDER_ATOMIC];
            };

            Blockly.Blocks['looks_say_for_secs'] = {
                init: function() {
                    this.appendValueInput("MESSAGE")
                        .setCheck("String")
                        .appendField("אמור");
                    this.appendValueInput("SECS")
                        .setCheck("Number")
                        .appendField("במשך");
                    this.appendDummyInput()
                        .appendField("שניות");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#9966FF');
                    this.setTooltip("Says a message for a certain number of seconds.");
                }
            };
            Blockly.JavaScript['looks_say_for_secs'] = function(block) {
                const message = Blockly.JavaScript.valueToCode(block, 'MESSAGE', Blockly.JavaScript.ORDER_NONE) || "''";
                const secs = Blockly.JavaScript.valueToCode(block, 'SECS', Blockly.JavaScript.ORDER_NONE) || '0';
                return `sayForSecs(${message}, ${secs});\n`;
            };
            
            Blockly.Blocks['looks_say'] = {
                init: function() {
                    this.appendValueInput("MESSAGE")
                        .setCheck("String")
                        .appendField("אמור");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#9966FF');
                    this.setTooltip("Says a message.");
                }
            };
            Blockly.JavaScript['looks_say'] = function(block) {
                const message = Blockly.JavaScript.valueToCode(block, 'MESSAGE', Blockly.JavaScript.ORDER_NONE) || "''";
                return `say(${message});\n`;
            };

            Blockly.Blocks['looks_show'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("הצג");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#9966FF');
                    this.setTooltip("Shows the sprite.");
                }
            };
            Blockly.JavaScript['looks_show'] = function(block) {
                return 'showSprite();\n';
            };

            Blockly.Blocks['looks_hide'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("הסתר");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#9966FF');
                    this.setTooltip("Hides the sprite.");
                }
            };
            Blockly.JavaScript['looks_hide'] = function(block) {
                return 'hideSprite();\n';
            };

            Blockly.Blocks['looks_set_transparency'] = {
                init: function() {
                    this.appendValueInput("TRANSPARENCY")
                        .setCheck("Number")
                        .appendField("שנה שקיפות ל-");
                    this.appendDummyInput()
                        .appendField("%");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#9966FF');
                    this.setTooltip("Sets the transparency of the sprite.");
                }
            };
            Blockly.JavaScript['looks_set_transparency'] = function(block) {
                const transparency = Blockly.JavaScript.valueToCode(block, 'TRANSPARENCY', Blockly.JavaScript.ORDER_NONE) || '0';
                return `setTransparency(${transparency});\n`;
            };

            Blockly.Blocks['looks_set_sprite'] = {
                init: function() {
                    this.appendValueInput("URL")
                        .setCheck("String")
                        .appendField("שנה דמות ל-");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#9966FF');
                    this.setTooltip("Changes the sprite image.");
                }
            };
            Blockly.JavaScript['looks_set_sprite'] = function(block) {
                const url = Blockly.JavaScript.valueToCode(block, 'URL', Blockly.JavaScript.ORDER_NONE) || "''";
                return `setSpriteUrl(${url});\n`;
            };

            Blockly.Blocks['control_wait_secs'] = {
                init: function() {
                    this.appendValueInput("SECS")
                        .setCheck("Number")
                        .appendField("חכה");
                    this.appendDummyInput()
                        .appendField("שניות");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#FF6B1A');
                    this.setTooltip("Waits for a specified number of seconds.");
                }
            };
            Blockly.JavaScript['control_wait_secs'] = function(block) {
                const secs = Blockly.JavaScript.valueToCode(block, 'SECS', Blockly.JavaScript.ORDER_NONE) || '1';
                return `await waitSecs(${secs});\n`;
            };

            Blockly.Blocks['control_repeat_times'] = {
                init: function() {
                    this.appendValueInput("TIMES")
                        .setCheck("Number")
                        .appendField("חזור");
                    this.appendDummyInput()
                        .appendField("פעמים");
                    this.appendStatementInput("DO")
                        .setCheck(null);
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour('#FF6B1A');
                    this.setTooltip("Repeats the enclosed blocks a number of times.");
                }
            };
            Blockly.JavaScript['control_repeat_times'] = function(block) {
                const times = Blockly.JavaScript.valueToCode(block, 'TIMES', Blockly.JavaScript.ORDER_NONE) || '0';
                const branch = Blockly.JavaScript.statementToCode(block, 'DO');
                const code = `for (let i = 0; i < ${times}; i++) {\n${branch}}\n`;
                return code;
            };

            Blockly.Blocks['control_forever'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("לנצח");
                    this.appendStatementInput("DO")
                        .setCheck(null);
                    this.setPreviousStatement(true, null);
                    this.setColour('#FF6B1A');
                    this.setTooltip("Repeats the enclosed blocks forever.");
                }
            };
            Blockly.JavaScript['control_forever'] = function(block) {
                const branch = Blockly.JavaScript.statementToCode(block, 'DO');
                const code = `while(true) {\n${branch}}\n`;
                return code;
            };

            Blockly.Blocks['operator_add'] = {
                init: function() {
                    this.appendValueInput("A")
                        .setCheck("Number");
                    this.appendDummyInput()
                        .appendField("+");
                    this.appendValueInput("B")
                        .setCheck("Number");
                    this.setOutput(true, "Number");
                    this.setColour('#40BF4A');
                    this.setTooltip("Adds two numbers.");
                }
            };
            Blockly.JavaScript['operator_add'] = function(block) {
                const a = Blockly.JavaScript.valueToCode(block, 'A', Blockly.JavaScript.ORDER_ADDITION) || '0';
                const b = Blockly.JavaScript.valueToCode(block, 'B', Blockly.JavaScript.ORDER_ADDITION) || '0';
                const code = `${a} + ${b}`;
                return [code, Blockly.JavaScript.ORDER_ADDITION];
            };

            Blockly.Blocks['operator_subtract'] = {
                init: function() {
                    this.appendValueInput("A")
                        .setCheck("Number");
                    this.appendDummyInput()
                        .appendField("-");
                    this.appendValueInput("B")
                        .setCheck("Number");
                    this.setOutput(true, "Number");
                    this.setColour('#40BF4A');
                    this.setTooltip("Subtracts two numbers.");
                }
            };
            Blockly.JavaScript['operator_subtract'] = function(block) {
                const a = Blockly.JavaScript.valueToCode(block, 'A', Blockly.JavaScript.ORDER_SUBTRACTION) || '0';
                const b = Blockly.JavaScript.valueToCode(block, 'B', Blockly.JavaScript.ORDER_SUBTRACTION) || '0';
                const code = `${a} - ${b}`;
                return [code, Blockly.JavaScript.ORDER_SUBTRACTION];
            };

            Blockly.Blocks['operator_multiply'] = {
                init: function() {
                    this.appendValueInput("A")
                        .setCheck("Number");
                    this.appendDummyInput()
                        .appendField("×");
                    this.appendValueInput("B")
                        .setCheck("Number");
                    this.setOutput(true, "Number");
                    this.setColour('#40BF4A');
                    this.setTooltip("Multiplies two numbers.");
                }
            };
            Blockly.JavaScript['operator_multiply'] = function(block) {
                const a = Blockly.JavaScript.valueToCode(block, 'A', Blockly.JavaScript.ORDER_MULTIPLICATION) || '0';
                const b = Blockly.JavaScript.valueToCode(block, 'B', Blockly.JavaScript.ORDER_MULTIPLICATION) || '0';
                const code = `${a} * ${b}`;
                return [code, Blockly.JavaScript.ORDER_MULTIPLICATION];
            };

            Blockly.Blocks['operator_divide'] = {
                init: function() {
                    this.appendValueInput("A")
                        .setCheck("Number");
                    this.appendDummyInput()
                        .appendField("/");
                    this.appendValueInput("B")
                        .setCheck("Number");
                    this.setOutput(true, "Number");
                    this.setColour('#40BF4A');
                    this.setTooltip("Divides two numbers.");
                }
            };
            Blockly.JavaScript['operator_divide'] = function(block) {
                const a = Blockly.JavaScript.valueToCode(block, 'A', Blockly.JavaScript.ORDER_DIVISION) || '0';
                const b = Blockly.JavaScript.valueToCode(block, 'B', Blockly.JavaScript.ORDER_DIVISION) || '0';
                const code = `${a} / ${b}`;
                return [code, Blockly.JavaScript.ORDER_DIVISION];
            };
            
            Blockly.Blocks['operator_random_number'] = {
                init: function() {
                    this.appendDummyInput()
                        .appendField("מספר אקראי בין")
                        .appendField(new Blockly.FieldTextInput("1"), "FROM")
                        .appendField("לבין")
                        .appendField(new Blockly.FieldTextInput("10"), "TO");
                    this.setOutput(true, "Number");
                    this.setColour('#40BF4A');
                    this.setTooltip("Returns a random number within a range.");
                }
            };
            Blockly.JavaScript['operator_random_number'] = function(block) {
                const from = block.getFieldValue('FROM');
                const to = block.getFieldValue('TO');
                const code = `Math.floor(Math.random() * (${to} - ${from} + 1)) + ${from}`;
                return [code, Blockly.JavaScript.ORDER_FUNCTION_CALL];
            };


            // הגדרת פונקציות לתפעול הבלוקים
            let runners = {};
            const runCode = async () => {
                if (!activeSprite) return;
                const code = Blockly.JavaScript.workspaceToCode(workspace);
                try {
                    const asyncCode = `(async () => { ${code} })();`;
                    await eval(asyncCode);
                } catch (e) {
                    log(`Error in code: ${e}`);
                }
            };

            const runOnStageClick = () => {
                const blocks = workspace.getBlocksByType('event_when_stage_clicked', true);
                blocks.forEach(async block => {
                    const code = Blockly.JavaScript.blockToCode(block, true);
                    const asyncCode = `(async () => { ${code} })();`;
                    await eval(asyncCode);
                });
            };

            const runOnKeyPress = (key) => {
                const blocks = workspace.getBlocksByType('event_when_key_pressed', true);
                blocks.forEach(async block => {
                    if (block.getFieldValue('KEY') === key) {
                        const code = Blockly.JavaScript.blockToCode(block, true);
                        const asyncCode = `(async () => { ${code} })();`;
                        await eval(asyncCode);
                    }
                });
            };

            const moveSteps = (steps) => {
                if (!activeSprite) return;
                const currentX = parseFloat(activeSprite.dataset.stageX) || 0;
                const currentY = parseFloat(activeSprite.dataset.stageY) || 0;
                const direction = parseFloat(activeSprite.dataset.direction) || 90;

                const newX = currentX + steps * Math.cos(direction * Math.PI / 180);
                const newY = currentY + steps * Math.sin(direction * Math.PI / 180);

                goToXY(newX, newY);
            };

            const turnRight = (degrees) => {
                if (!activeSprite) return;
                let currentDirection = parseFloat(activeSprite.dataset.direction) || 90;
                let newDirection = (currentDirection - degrees) % 360;
                if (newDirection < 0) newDirection += 360;
                activeSprite.dataset.direction = newDirection;
                activeSprite.style.transform += ` rotate(${degrees}deg)`;
            };

            const turnLeft = (degrees) => {
                if (!activeSprite) return;
                let currentDirection = parseFloat(activeSprite.dataset.direction) || 90;
                let newDirection = (currentDirection + degrees) % 360;
                if (newDirection < 0) newDirection += 360;
                activeSprite.dataset.direction = newDirection;
                activeSprite.style.transform += ` rotate(-${degrees}deg)`;
            };

            const setDirection = (degrees) => {
                if (!activeSprite) return;
                activeSprite.dataset.direction = degrees;
                activeSprite.style.transform = `translate(calc(-50% + ${activeSprite.style.left}), calc(-50% + ${activeSprite.style.top})) rotate(${degrees - 90}deg)`;
            };

            const goToXY = (x, y) => {
                if (!activeSprite) return;
                activeSprite.dataset.stageX = x;
                activeSprite.dataset.stageY = y;
                const cssX = (x / (STAGE_WIDTH / 2)) * (stageArea.clientWidth / 2);
                const cssY = -1 * (y / (STAGE_HEIGHT / 2)) * (stageArea.clientHeight / 2);
                activeSprite.style.transform = `translate(calc(-50% + ${cssX}px), calc(-50% + ${cssY}px))`;
                updateCoordsDisplay(activeSprite);
            };

            const glideToXY = (secs, x, y) => {
                if (!activeSprite) return;
                const startX = parseFloat(activeSprite.dataset.stageX);
                const startY = parseFloat(activeSprite.dataset.stageY);
                const totalTime = secs * 1000;
                const startTime = Date.now();
                const animate = () => {
                    const elapsedTime = Date.now() - startTime;
                    const progress = Math.min(elapsedTime / totalTime, 1);
                    const newX = startX + (x - startX) * progress;
                    const newY = startY + (y - startY) * progress;
                    goToXY(newX, newY);
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };
                animate();
            };

            const getSpriteX = () => {
                return parseFloat(activeSprite.dataset.stageX) || 0;
            };

            const getSpriteY = () => {
                return parseFloat(activeSprite.dataset.stageY) || 0;
            };

            const sayForSecs = (message, secs) => {
                showSpeechBubble(activeSprite, message, secs);
            };

            const say = (message) => {
                showSpeechBubble(activeSprite, message, 0);
            };

            const showSprite = () => {
                if (activeSprite) {
                    activeSprite.style.opacity = 1;
                }
            };

            const hideSprite = () => {
                if (activeSprite) {
                    activeSprite.style.opacity = 0;
                }
            };

            const setTransparency = (transparency) => {
                if (activeSprite) {
                    const opacity = 1 - (transparency / 100);
                    activeSprite.style.opacity = opacity;
                }
            };

            const setSpriteUrl = (url) => {
                if (activeSprite) {
                    const img = activeSprite.querySelector('img');
                    img.src = url;
                }
            };

            const waitSecs = (secs) => {
                return new Promise(resolve => setTimeout(resolve, secs * 1000));
            };

            // אתחול Blockly
            const initializeBlockly = () => {
                const blocklyArea = document.getElementById('blockly-area');
                const toolbox = document.getElementById('toolbox');
                workspace = Blockly.inject(blocklyArea, {
                    toolbox: toolbox,
                    rtl: true,
                    horizontalLayout: false,
                    scrollbars: true,
                    zoom: {
                        controls: true,
                        wheel: true,
                        startScale: 1.0,
                        maxScale: 3,
                        minScale: 0.3,
                        scaleSpeed: 1.2
                    }
                });
                workspace.addChangeListener(saveActiveSpriteBlocks);
            };
            
            // אתחול הדמויות, רקעים וכפתורים
            const setupUI = () => {
                initializeBlockly();
                const defaultSprite = createNewSprite('חתול', 'https://codejredu.github.io/claudejr/GingerCat.svg');
                setActiveSprite(defaultSprite);

                addSpriteButton.addEventListener('click', () => {
                    createNewSprite('חתול', 'https://codejredu.github.io/claudejr/GingerCat.svg');
                });

                addBackdropButton.addEventListener('click', () => {
                    backgroundGallery.classList.add('visible');
                });

                closeGalleryButton.addEventListener('click', () => {
                    backgroundGallery.classList.remove('visible');
                });

                thumbnailsGrid.addEventListener('click', (e) => {
                    if (e.target.tagName === 'IMG') {
                        const newBgUrl = e.target.src;
                        stageArea.style.backgroundImage = `url('${newBgUrl}')`;
                        backgroundGallery.classList.remove('visible');
                    }
                });

                document.getElementById('run-button').addEventListener('click', () => {
                    runCode();
                });
                
                stageArea.addEventListener('click', runOnStageClick);
                document.addEventListener('keydown', (e) => runOnKeyPress(e.key));
            };

            // קריאה לפונקציית ההתחלה
            setupUI();

            // התאמת גודל הבמה
            const resizeStage = () => {
                const stageAspectRatioWrapper = document.getElementById('stage-aspect-ratio-wrapper');
                const rect = stageAspectRatioWrapper.getBoundingClientRect();
                const ratio = STAGE_WIDTH / STAGE_HEIGHT;
                if (rect.width > rect.height * ratio) {
                    stageArea.style.width = `${rect.height * ratio}px`;
                    stageArea.style.height = `${rect.height}px`;
                } else {
                    stageArea.style.width = `${rect.width}px`;
                    stageArea.style.height = `${rect.width / ratio}px`;
                }
                if (activeSprite) {
                    goToXY(parseFloat(activeSprite.dataset.stageX), parseFloat(activeSprite.dataset.stageY));
                }
            };
            
            window.addEventListener('resize', () => {
                resizeStage();
                if (workspace) {
                    Blockly.svgResize(workspace);
                }
            });
            resizeStage(); // קריאה ראשונית להתאמת הגודל
        });
    </script>
</body>
</html>
