<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בלוקלי: פריסה בסגנון סקראץ'</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/blockly@9.0.0/blockly.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container-wrapper {
            display: flex;
            flex-direction: row-reverse;
            justify-content: center;
            align-items: flex-start;
            gap: 1.5rem;
            width: 100%;
            max-width: 1400px;
            padding: 2rem;
            box-sizing: border-box;
        }
        .left-panel {
            display: flex;
            flex-direction: column;
            width: 25%;
            flex-shrink: 0;
            gap: 1.5rem;
        }
        .right-panel {
            display: flex;
            flex-direction: column;
            width: 75%;
            gap: 1.5rem;
        }
        #stage-aspect-ratio-wrapper {
            position: relative;
            width: 100%;
            padding-top: 75%;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: #fff;
            border: 2px solid #ccc;
        }
        #stage-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            border-radius: 12px;
        }
        .sprite-wrapper {
            position: absolute;
            width: 80px;
            height: 80px;
            background-color: transparent;
            border-radius: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            transform: translate(calc(-50% + 0px), calc(-50% + 0px));
            transition: transform 0.1s ease-out;
            z-index: 10;
            opacity: 1;
            cursor: grab;
        }
        .sprite-wrapper:active {
            cursor: grabbing;
        }
        .sprite-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 0;
        }
        .speech-bubble {
            position: absolute;
            background: #fdfd96;
            border-radius: 12px;
            padding: 8px 12px;
            border: 1px solid #ccc;
            white-space: nowrap;
            font-size: 0.9rem;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .speech-bubble::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 100%;
            width: 0;
            height: 0;
            border: 8px solid transparent;
            border-top-color: #fdfd96;
            border-bottom: 0;
            margin-left: -8px;
            margin-top: -1px;
        }
        .speech-bubble.visible {
            opacity: 1;
        }
        #blockly-area {
            flex-grow: 1;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: 80vh;
            min-height: 500px;
        }
        .section {
            background-color: #fff;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #ccc;
            position: relative;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .section-header h2 {
            font-size: 1.25rem;
            font-weight: bold;
        }
        .plus-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #4C97FF;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .section-content {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }
        .sprite-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 0.5rem;
            cursor: pointer;
            transition: border-color 0.2s;
            position: relative;
        }
        .sprite-card.selected {
            border-color: #4C97FF;
        }
        .sprite-card img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 8px;
        }
        .delete-button {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            cursor: pointer;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .sprite-card:hover .delete-button {
            visibility: visible;
            opacity: 1;
        }
        .backdrop-card {
            width: 80px;
            height: 60px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            transition: border-color 0.2s;
        }
        .backdrop-card.selected {
            border-color: #4C97FF;
        }
        .gallery-container {
            width: 100%;
            padding: 1rem;
            background-color: #f0f4f8;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: none;
            transition: all 0.5s ease-in-out;
            border: 2px solid #ccc;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 20;
            height: 100%;
            overflow-y: auto;
        }
        .gallery-container.visible {
            display: block;
        }
        .thumbnail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
        }
        @media (min-width: 768px) {
            .thumbnail-grid {
                grid-template-columns: repeat(5, minmax(0, 1fr));
            }
        }
        .thumbnail {
            width: 100%;
            height: auto;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .thumbnail.selected {
            border: 3px solid #4C97FF;
        }
        .close-gallery-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: #ccc;
            color: #333;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .protractor-container {
            position: absolute;
            z-index: 9999;
            background-color: #ffffff;
            border: 2px solid #333;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            user-select: none;
            -webkit-user-select: none;
        }
        .protractor-canvas {
            cursor: crosshair;
        }
        .protractor-value {
            font-size: 1.25rem;
            font-weight: bold;
            margin-top: 10px;
            color: #333;
        }
        .protractor-close {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #ef4444;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
        }
        /* Mobile layout adjustments */
        @media (max-width: 768px) {
            .container-wrapper {
                flex-direction: column;
                padding: 1rem;
            }
            .left-panel, .right-panel {
                width: 100%;
            }
            #blockly-area {
                height: 60vh;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="container-wrapper" class="container-wrapper">
        <div class="left-panel">
            <h1 class="text-3xl font-bold mb-4 text-center">במה של החתול</h1>
            <div id="stage-aspect-ratio-wrapper" class="w-full relative">
                <div id="stage-area">
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>דמויות</h2>
                    <div id="add-sprite-button" class="plus-button">+</div>
                </div>
                <div id="sprites-list" class="section-content">
                </div>
                <div id="sprite-gallery" class="gallery-container">
                    <button class="close-gallery-button" id="close-sprite-gallery-button">X</button>
                    <h2 class="text-xl font-bold text-center mb-4">גלריית דמויות</h2>
                    <div id="sprite-thumbnails-grid" class="thumbnail-grid">
                        <img src="https://codejredu.github.io/claudejr/Chick.svg" alt="Chick" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/Rabbit.svg" alt="Rabbit" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/Beetle.svg" alt="Beetle" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/GingerCat.svg" alt="GingerCat" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/AmericanFootball.svg" alt="AmericanFootball" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/Basketball.svg" alt="Basketball" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/Football.svg" alt="Football" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/Dog.svg" alt="Dog" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/PistonPlane.svg" alt="PistonPlane" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/ColorfulPlane.svg" alt="ColorfulPlane" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/YellowCar.svg" alt="YellowCar" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/Helicopter.svg" alt="Helicopter" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/SpaceShuttle.svg" alt="SpaceShuttle" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/Truck.svg" alt="Truck" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/Tiger.svg" alt="Tiger" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/Rhino.svg" alt="Rhino" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/Spindle.svg" alt="Spindle" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/Crab.svg" alt="Crab" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/GreenSpottedTree.svg" alt="GreenSpottedTree" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/Flamingo.svg" alt="Flamingo" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/Flower.svg" alt="Flower" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/Monkey.svg" alt="Monkey" class="thumbnail">
                        <img src="https://codejredu.github.io/claudejr/Crocodile.svg" alt="Crocodile" class="thumbnail">
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2>צלילים</h2>
                    <div id="add-sound-button" class="plus-button">+</div>
                </div>
                <div id="sounds-list" class="section-content">
                    <div class="sound-card">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-12 h-12 text-gray-500">
                            <path d="M13.5 4.5a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM12 18.75a7.5 7.5 0 00-4.721-6.766L7.5 12h-.779c-2.15 0-4.14-1.285-5.328-3.359.18-.553.77-.959 1.488-.959h11.15c.718 0 1.307.406 1.487.96-.282.525-.43 1.11-.429 1.704a4.496 4.496 0 01-1.298 3.163A6.096 6.096 0 0012 18.75z"/>
                            <path fill-rule="evenodd" d="M19.303 7.643a.75.75 0 111.061 1.061l-3.385 3.384a.75.75 0 01-1.061-1.06l3.385-3.386zM15.918 2.628a.75.75 0 01.993 1.121C15.612 4.605 14.218 6 12.5 6a.75.75 0 010-1.5c1.474 0 2.806-1.139 3.593-2.628z" clip-rule="evenodd"/>
                        </svg>
                        <span class="text-sm mt-1">צליל ברירת מחדל</span>
                    </div>
                </div>
            </div>

            <div class="section" id="backdrops-section">
                <div class="section-header">
                    <h2>רקעים</h2>
                    <div id="add-backdrop-button" class="plus-button">+</div>
                </div>
                <div id="backdrops-list" class="section-content">
                </div>
                <div id="background-gallery" class="gallery-container">
                    <button class="close-gallery-button" id="close-gallery-button">X</button>
                    <h2 class="text-xl font-bold text-center mb-4">גלריית רקעים</h2>
                    <div id="thumbnails-grid" class="thumbnail-grid">
                        <img src="https://codejredu.github.io/test/assets/bg/Amphitheater.svg" alt="Amphitheater" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/canyon.svg" alt="canyon" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/canyon1.svg" alt="canyon1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/castel.svg" alt="castel" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/castel1.svg" alt="castel1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/citynight.svg" alt="citynight" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/citynight2.svg" alt="citynight2" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/colorfulcity.svg" alt="colorfulcity" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/colorfulcity1.svg" alt="colorfulcity1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/desert.svg" alt="desert" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/desert1.svg" alt="desert1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/farm.svg" alt="farm" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/kidbadroom.svg" alt="kidbadroom" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/kidbadroom1.svg" alt="kidbadroom1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/moon.svg" alt="moon" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/road1.svg" alt="road1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/road2.svg" alt="road2" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/room1.svg" alt="room1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/room2.svg" alt="room2" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/savanna1.svg" alt="savanna1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/savanna2.svg" alt="savanna2" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/school1.svg" alt="school1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/slopes1.svg" alt="slopes1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/slopes2.svg" alt="slopes2" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/soccer1.svg" alt="soccer1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/soccer2.svg" alt="soccer2" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/winter1.svg" alt="winter1" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/winter2.svg" alt="winter2" class="thumbnail">
                        <img src="https://codejredu.github.io/test/assets/bg/under.svg" alt="under" class="thumbnail">
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div id="blockly-area" class="h-[80vh] min-h-[500px] w-full rounded-2xl"></div>
            <div class="flex flex-row space-x-2 space-x-reverse justify-center mt-4">
                <button id="run-button" class="px-6 py-3 bg-green-500 text-white font-bold rounded-full shadow-md hover:bg-green-600 transition-colors">
                    <span class="ml-2">הפעל</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.127l-3.328 2.378a.999.999 0 01-1.424-.712V8.92c0-.525.53-.787 1.055-.443l3.328 2.378a.999.999 0 01-.031 1.094z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
                <button id="reset-button" class="px-6 py-3 bg-red-500 text-white font-bold rounded-full shadow-md hover:bg-red-600 transition-colors">
                    <span class="ml-2">אפס</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m16.733 11.234A9.975 9.975 0 0112 21c-5.523 0-10-4.477-10-10S6.477 1 12 1s10 4.477 10 10c0 .487-.04.965-.118 1.432m-11.234 3.733l-4 4L4 16m9-13.885v3.424m-4.542 6.556l-3.79-3.79M17.458 12.062L13.668 15.852" />
                    </svg>
                </button>
                <button id="fullscreen-button" class="px-6 py-3 bg-blue-500 text-white font-bold rounded-full shadow-md hover:bg-blue-600 transition-colors">
                    <span class="ml-2">מסך מלא</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m0 0l-5 5m0 5v4m0 0h4m0 0l-5-5m-9 5v4m0 0h-4m0 0l5-5" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <xml id="toolbox" style="display: none">
        <category name="אירועים" colour="#FFD95A">
            <block type="event_when_flag_clicked"></block>
            <block type="event_when_stage_clicked"></block>
            <block type="event_when_key_pressed"></block>
        </category>
        <category name="תנועה" colour="#4C97FF">
            <block type="motion_move_steps">
                <value name="STEPS">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="motion_turn_right_degrees">
                <value name="DEGREES">
                    <shadow type="math_number">
                        <field name="NUM">15</field>
                    </shadow>
                </value>
            </block>
            <block type="motion_turn_left_degrees">
                <value name="DEGREES">
                    <shadow type="math_number">
                        <field name="NUM">15</field>
                    </shadow>
                </value>
            </block>
            <block type="motion_set_direction">
                <field name="DEGREES">90</field>
            </block>
            <block type="motion_go_to_xy">
                <value name="X">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
                <value name="Y">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
            </block>
            <block type="motion_glide_to_xy">
                <value name="SECS">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
                <value name="X">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
                <value name="Y">
                    <shadow type="math_number">
                        <field name="NUM">0</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="מראה" colour="#9966FF">
            <block type="looks_say_for_secs">
                <value name="MESSAGE">
                    <shadow type="text">
                        <field name="TEXT">שלום!</field>
                    </shadow>
                </value>
                <value name="SECS">
                    <shadow type="math_number">
                        <field name="NUM">2</field>
                    </shadow>
                </value>
            </block>
            <block type="looks_say">
                <value name="MESSAGE">
                    <shadow type="text">
                        <field name="TEXT">שלום!</field>
                    </shadow>
                </value>
            </block>
            <block type="looks_show"></block>
            <block type="looks_hide"></block>
            <block type="looks_set_transparency">
                <value name="TRANSPARENCY">
                    <shadow type="math_number">
                        <field name="NUM">50</field>
                    </shadow>
                </value>
            </block>
        </category>
        <category name="בקרה" colour="#FF6B1A">
            <block type="control_wait_secs">
                <value name="SECS">
                    <shadow type="math_number">
                        <field name="NUM">1</field>
                    </shadow>
                </value>
            </block>
            <block type="control_repeat_times">
                <value name="TIMES">
                    <shadow type="math_number">
                        <field name="NUM">10</field>
                    </shadow>
                </value>
            </block>
            <block type="control_forever"></block>
        </category>
        <category name="אופרטורים" colour="#40BF4A">
            <block type="operator_add"></block>
            <block type="operator_subtract"></block>
            <block type="operator_multiply"></block>
            <block type="operator_divide"></block>
            <block type="operator_random_number">
                <field name="FROM">1</field>
                <field name="TO">10</field>
            </block>
        </category>
    </xml>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const stageArea = document.getElementById('stage-area');
            const containerWrapper = document.getElementById('container-wrapper');
            const fullscreenButton = document.getElementById('fullscreen-button');
            const addSpriteButton = document.getElementById('add-sprite-button');
            const spritesList = document.getElementById('sprites-list');
            const addBackdropButton = document.getElementById('add-backdrop-button');
            const backdropsList = document.getElementById('backdrops-list');
            const backdropsSection = document.getElementById('backdrops-section');
            const backgroundGallery = document.getElementById('background-gallery');
            const closeGalleryButton = document.getElementById('close-gallery-button');
            const thumbnailsGrid = document.getElementById('thumbnails-grid');
            const spriteGallery = document.getElementById('sprite-gallery');
            const closeSpriteGalleryButton = document.getElementById('close-sprite-gallery-button');
            const spriteThumbnailsGrid = document.getElementById('sprite-thumbnails-grid');

            const STAGE_WIDTH = 480;
            const STAGE_HEIGHT = 360;

            let workspace;
            let activeSprite = null;
            
            const log = (message) => {
                console.log(message);
            };

            const updateSpritePosition = () => {
                if (!activeSprite) return;
                const spriteEl = document.getElementById(activeSprite.id);
                if (spriteEl) {
                    const rect = stageArea.getBoundingClientRect();
                    const stageX = activeSprite.x / (STAGE_WIDTH / rect.width);
                    const stageY = -activeSprite.y / (STAGE_HEIGHT / rect.height);
                    spriteEl.style.transform = `translate(calc(-50% + ${stageX}px), calc(-50% + ${stageY}px)) rotate(${activeSprite.direction - 90}deg)`;
                    spriteEl.style.opacity = activeSprite.opacity;
                }
            };
            
            const createNewSprite = (name, imageUrl, initialX = 0, initialY = 0) => {
                const id = `sprite-${Date.now()}`;
                const spriteData = {
                    id,
                    name,
                    imageUrl,
                    x: initialX,
                    y: initialY,
                    direction: 90,
                    opacity: 1
                };
                
                const spriteCard = document.createElement('div');
                spriteCard.classList.add('sprite-card');
                spriteCard.dataset.spriteId = id;
                spriteCard.innerHTML = `
                    <img src="${imageUrl}" alt="${name}">
                    <span class="text-sm mt-1">${name}</span>
                    <div class="delete-button">X</div>
                `;
                spritesList.appendChild(spriteCard);

                const spriteOnStage = document.createElement('div');
                spriteOnStage.classList.add('sprite-wrapper');
                spriteOnStage.id = id;
                spriteOnStage.innerHTML = `
                    <img src="${imageUrl}" alt="${name}">
                    <div class="speech-bubble"></div>
                `;
                stageArea.appendChild(spriteOnStage);
                
                spriteCard.addEventListener('click', () => {
                    setActiveSprite(spriteData);
                });
                spriteOnStage.addEventListener('mousedown', (e) => startDrag(e, spriteData));
                spriteOnStage.addEventListener('touchstart', (e) => startDrag(e, spriteData));
                spriteCard.querySelector('.delete-button').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteSprite(id);
                });

                setActiveSprite(spriteData);
                updateSpritePosition();
                return spriteData;
            };

            const deleteSprite = (id) => {
                document.getElementById(id).remove();
                document.querySelector(`.sprite-card[data-sprite-id="${id}"]`).remove();
                if (activeSprite && activeSprite.id === id) {
                    activeSprite = null;
                    const firstSprite = spritesList.querySelector('.sprite-card');
                    if (firstSprite) {
                        setActiveSprite({ id: firstSprite.dataset.spriteId });
                    }
                }
                log(`הדמות ${id} נמחקה.`);
            };
            
            const setActiveSprite = (spriteData) => {
                if (activeSprite) {
                    const prevCard = document.querySelector(`.sprite-card[data-sprite-id="${activeSprite.id}"]`);
                    if (prevCard) {
                        prevCard.classList.remove('selected');
                    }
                }
                activeSprite = spriteData;
                const newCard = document.querySelector(`.sprite-card[data-sprite-id="${spriteData.id}"]`);
                if (newCard) {
                    newCard.classList.add('selected');
                }
                log(`הדמות הפעילה היא: ${activeSprite.name}`);
            };

            let isDragging = false;
            let initialMouseX, initialMouseY, initialSpriteX, initialSpriteY;

            const getPointerPosition = (e) => {
                const isTouch = e.touches && e.touches.length > 0;
                return { x: isTouch ? e.touches[0].clientX : e.clientX, y: isTouch ? e.touches[0].clientY : e.clientY };
            };
            
            const startDrag = (e, spriteData) => {
                e.preventDefault();
                isDragging = true;
                setActiveSprite(spriteData);
                const { x, y } = getPointerPosition(e);
                initialMouseX = x;
                initialMouseY = y;
                initialSpriteX = activeSprite.x;
                initialSpriteY = activeSprite.y;
                document.getElementById(activeSprite.id).style.transition = 'none';
                log('הדמות נתפסה לגרירה.');
            };

            const drag = (e) => {
                if (isDragging && activeSprite) {
                    const { x, y } = getPointerPosition(e);
                    const deltaX = x - initialMouseX;
                    const deltaY = y - initialMouseY;
                    
                    const rect = stageArea.getBoundingClientRect();
                    const scaleX = STAGE_WIDTH / rect.width;
                    const scaleY = STAGE_HEIGHT / rect.height;

                    activeSprite.x = initialSpriteX + deltaX * scaleX;
                    activeSprite.y = initialSpriteY - deltaY * scaleY;
                    
                    updateSpritePosition();
                }
            };

            const endDrag = () => {
                if (isDragging) {
                    isDragging = false;
                    if (activeSprite) {
                        document.getElementById(activeSprite.id).style.transition = 'transform 0.5s ease-out';
                        log(`הדמות נגררה למיקום חדש (x: ${activeSprite.x.toFixed(0)}, y: ${activeSprite.y.toFixed(0)})`);
                    }
                }
            };

            stageArea.addEventListener('mousemove', drag);
            stageArea.addEventListener('touchmove', drag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
            document.addEventListener('touchcancel', endDrag);

            window.addEventListener('resize', () => {
                updateSpritePosition();
            });

            Blockly.Blocks['event_when_flag_clicked'] = {
                init: function() {
                    this.appendDummyInput().appendField(new Blockly.FieldImage("https://codejredu.github.io/test/assets/blocklyicon//flag.svg", 24, 24, { alt: "green flag", flipRtl: "false" }));
                    this.setNextStatement(true, null);
                    this.setColour("#FFD95A");
                    this.setTooltip("התחל את התסריט כאשר הדגל הירוק נלחץ.");
                    this.setHelpUrl("");
                }
            };
            Blockly.JavaScript['event_when_flag_clicked'] = function(block) { return ''; };

            Blockly.Blocks['event_when_stage_clicked'] = {
                init: function() {
                    this.appendDummyInput().appendField(new Blockly.FieldImage("https://placehold.co/24x24/6495ED/FFFFFF?text=במה", 24, 24, { alt: "stage icon", flipRtl: "false" }));
                    this.setNextStatement(true, null);
                    this.setColour("#FFD95A");
                    this.setTooltip("הפעל את התסריט כאשר לוחצים על אזור הבמה.");
                    this.setHelpUrl("");
                }
            };
            Blockly.JavaScript['event_when_stage_clicked'] = function(block) { return ''; };

            Blockly.Blocks['event_when_key_pressed'] = {
                init: function() {
                    this.appendDummyInput().appendField(new Blockly.FieldImage("https://codejredu.github.io/test/assets/blocklyicon/keyboard.svg", 24, 24, { alt: "keyboard icon", flipRtl: "false" })).appendField(new Blockly.FieldDropdown([
                        ["רווח", "SPACE"], ["חץ למעלה", "UP"], ["חץ למטה", "DOWN"], ["חץ ימינה", "RIGHT"], ["חץ שמאלה", "LEFT"]
                    ]), "KEY");
                    this.setNextStatement(true, null);
                    this.setColour("#FFD95A");
                    this.setTooltip("הפעל קוד כאשר מקש נלחץ. (פונקציונליות זו אינה נתמכת במלואה בדוגמה הנוכחית.)");
                    this.setHelpUrl("");
                }
            };
            Blockly.JavaScript['event_when_key_pressed'] = function(block) { return ''; };

            Blockly.Blocks['motion_move_steps'] = {
                init: function() {
                    this.appendValueInput("STEPS").setCheck("Number").setAlign(Blockly.ALIGN_RIGHT)
                        .appendField(new Blockly.FieldImage("https://codejredu.github.io/test/assets/blocklyicon//walk.svg", 24, 24, "*")).appendField("");
                    this.setInputsInline(true);
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#4C97FF");
                    this.setTooltip("הזז את הדמות בכיוון שהיא פונה.");
                }
            };
            Blockly.JavaScript['motion_move_steps'] = function(block) {
                const steps = Blockly.JavaScript.valueToCode(block, 'STEPS', Blockly.JavaScript.ORDER_NONE) || '10';
                return `
                    if (activeSprite) {
                        await new Promise(resolve => {
                            // Scratch coordinates: 0 is up, increases clockwise
                            const radians = activeSprite.direction * Math.PI / 180;
                            activeSprite.x += ${steps} * Math.sin(radians);
                            activeSprite.y += ${steps} * Math.cos(radians);
                            updateSpritePosition();
                            log('הדמות זזה ' + ${steps} + ' צעדים.');
                            setTimeout(resolve, 500);
                        });
                    }
                `;
            };
            Blockly.Blocks['motion_turn_right_degrees'] = {
                init: function() {
                    this.appendValueInput("DEGREES").setCheck("Number")
                        .appendField(new Blockly.FieldImage("https://github.com/codejredu/test/raw/main/assets/blocklyicon/right.png", 24, 24, { alt: "turn right icon", flipRtl: "false" })).appendField("")
                    this.setInputsInline(true);
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#4C97FF");
                    this.setTooltip("סובב את הדמות ימינה.");
                }
            };
            Blockly.JavaScript['motion_turn_right_degrees'] = function(block) {
                const degrees = Blockly.JavaScript.valueToCode(block, 'DEGREES', Blockly.JavaScript.ORDER_ATOMIC) || '15';
                return `
                    if (activeSprite) {
                        await new Promise(resolve => {
                            activeSprite.direction += ${degrees};
                            updateSpritePosition();
                            log('הדמות הסתובבה ימינה ב-' + ${degrees} + ' מעלות.');
                            setTimeout(resolve, 10);
                        });
                    }
                `;
            };
            Blockly.Blocks['motion_turn_left_degrees'] = {
                init: function() {
                    this.appendValueInput("DEGREES").setCheck("Number")
                        .appendField(new Blockly.FieldImage("https://github.com/codejredu/test/raw/main/assets/blocklyicon/left.png", 24, 24, { alt: "turn left icon", flipRtl: "false" })).appendField("");
                    this.setInputsInline(true);
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#4C97FF");
                    this.setTooltip("סובב את הדמות שמאלה.");
                }
            };
            Blockly.JavaScript['motion_turn_left_degrees'] = function(block) {
                const degrees = Blockly.JavaScript.valueToCode(block, 'DEGREES', Blockly.JavaScript.ORDER_ATOMIC) || '15';
                return `
                    if (activeSprite) {
                        await new Promise(resolve => {
                            activeSprite.direction -= ${degrees};
                            updateSpritePosition();
                            log('הדמות הסתובבה שמאלה ב-' + ${degrees} + ' מעלות.');
                            setTimeout(resolve, 10);
                        });
                    }
                `;
            };
            
            Blockly.Blocks['motion_set_direction'] = {
                init: function() {
                    const angleValidator = (newValue) => {
                        if (activeSprite) {
                            activeSprite.direction = newValue;
                            updateSpritePosition();
                        }
                        return newValue; // Return the value to set it on the block
                    };

                    this.appendDummyInput()
                        .appendField(new Blockly.FieldImage("https://codejredu.github.io/test/assets/blocklyicon/compass.svg", 24, 24, { alt: "compass icon", flipRtl: "false" }))
                        .appendField("")
                        .appendField(new Blockly.FieldAngle('90', angleValidator), 'DEGREES');
                    this.setInputsInline(true);
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#4C97FF");
                    this.setTooltip("קבע את כיוון הדמות.");
                }
            };
            Blockly.JavaScript['motion_set_direction'] = function(block) {
                const degrees = block.getFieldValue('DEGREES');
                return `
                    if (activeSprite) {
                        await new Promise(resolve => {
                            activeSprite.direction = ${degrees};
                            updateSpritePosition();
                            log('הדמות קבעה כיוון ל-' + ${degrees} + ' מעלות.');
                            setTimeout(resolve, 10);
                        });
                    }
                `;
            };
            
            Blockly.Blocks['looks_say_for_secs'] = {
                init: function() {
                    this.appendValueInput("MESSAGE").setCheck("String").setAlign(Blockly.ALIGN_RIGHT)
                        .appendField(new Blockly.FieldImage("https://codejredu.github.io/test/assets/blocklyicon/say.png", 24, 24, { alt: "say icon", flipRtl: "false" }))
                        .appendField("");
                    this.appendValueInput("SECS").setCheck("Number").setAlign(Blockly.ALIGN_RIGHT).appendField("");
                    this.setInputsInline(true);
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#9966FF");
                    this.setTooltip("גרום לדמות לומר הודעה למשך מספר שניות.");
                }
            };
            Blockly.JavaScript['looks_say_for_secs'] = function(block) {
                const message = Blockly.JavaScript.valueToCode(block, 'MESSAGE', Blockly.JavaScript.ORDER_ATOMIC) || "''";
                const secs = Blockly.JavaScript.valueToCode(block, 'SECS', Blockly.JavaScript.ORDER_ATOMIC) || '2';
                return `
                    if (activeSprite) {
                        await new Promise(resolve => {
                            const spriteEl = document.getElementById(activeSprite.id);
                            const bubble = spriteEl.querySelector('.speech-bubble');
                            bubble.textContent = ${message};
                            bubble.classList.add('visible');
                            log('הדמות אומרת: ' + ${message});
                            setTimeout(() => {
                                bubble.classList.remove('visible');
                                resolve();
                            }, ${secs} * 1000);
                        });
                    }
                `;
            };
            Blockly.Blocks['looks_say'] = {
                init: function() {
                    this.appendValueInput("MESSAGE").setCheck("String").setAlign(Blockly.ALIGN_RIGHT)
                        .appendField(new Blockly.FieldImage("https://codejredu.github.io/test/assets/blocklyicon/say.png", 24, 24, { alt: "say icon", flipRtl: "false" }))
                        .appendField("");
                    this.setInputsInline(true);
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#9966FF");
                    this.setTooltip("גרום לדמות לומר הודעה.");
                }
            };
            Blockly.JavaScript['looks_say'] = function(block) {
                const message = Blockly.JavaScript.valueToCode(block, 'MESSAGE', Blockly.JavaScript.ORDER_ATOMIC) || "''";
                return `
                    if (activeSprite) {
                        const spriteEl = document.getElementById(activeSprite.id);
                        const bubble = spriteEl.querySelector('.speech-bubble');
                        bubble.textContent = ${message};
                        bubble.classList.add('visible');
                        log('הדמות אומרת: ' + ${message});
                    }
                `;
            };
            Blockly.Blocks['looks_show'] = {
                init: function() {
                    this.appendDummyInput().appendField(new Blockly.FieldImage("https://codejredu.github.io/test/assets/blocklyicon/show.png", 24, 24, { alt: "show icon", flipRtl: "false" })).appendField("");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#9966FF");
                    this.setTooltip("הצג את הדמות.");
                }
            };
            Blockly.JavaScript['looks_show'] = function(block) {
                return `
                    if (activeSprite) {
                        activeSprite.opacity = 1;
                        updateSpritePosition();
                        log('הדמות הוצגה.');
                    }
                `;
            };
            Blockly.Blocks['looks_hide'] = {
                init: function() {
                    this.appendDummyInput().appendField(new Blockly.FieldImage("https://codejredu.github.io/test/assets/blocklyicon/hide.png", 24, 24, { alt: "hide icon", flipRtl: "false" })).appendField("");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#9966FF");
                    this.setTooltip("הסתר את הדמות.");
                }
            };
            Blockly.JavaScript['looks_hide'] = function(block) {
                return `
                    if (activeSprite) {
                        activeSprite.opacity = 0;
                        updateSpritePosition();
                        log('הדמות הוסתרה.');
                    }
                `;
            };
            Blockly.Blocks['looks_set_transparency'] = {
                init: function() {
                    this.appendValueInput("TRANSPARENCY").setCheck("Number").setAlign(Blockly.ALIGN_RIGHT)
                        .appendField(new Blockly.FieldImage("https://codejredu.github.io/test/assets/blocklyicon/opacity.png", 24, 24, { alt: "opacity icon", flipRtl: "false" }))
                        .appendField("");
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#9966FF");
                    this.setTooltip("קבע את רמת השקיפות של הדמות (0-100).");
                }
            };
            Blockly.JavaScript['looks_set_transparency'] = function(block) {
                const transparency = Blockly.JavaScript.valueToCode(block, 'TRANSPARENCY', Blockly.JavaScript.ORDER_ATOMIC) || '0';
                return `
                    if (activeSprite) {
                        activeSprite.opacity = 1 - (${transparency} / 100);
                        updateSpritePosition();
                        log('שקיפות הדמות נקבעה ל-' + ${transparency} + '%.');
                    }
                `;
            };
            
            Blockly.Blocks['control_wait_secs'] = {
                init: function() {
                    this.appendValueInput("SECS").setCheck("Number").setAlign(Blockly.ALIGN_RIGHT).appendField(new Blockly.FieldImage("https://github.com/codejredu/test/raw/main/assets/blocklyicon/wait.png", 24, 24, "*")).appendField("");
                    this.appendDummyInput().appendField("");
                    this.setInputsInline(true);
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#FF6B1A");
                    this.setTooltip("המתן למשך מספר שניות.");
                }
            };
            Blockly.JavaScript['control_wait_secs'] = function(block) {
                const secs = Blockly.JavaScript.valueToCode(block, 'SECS', Blockly.JavaScript.ORDER_ATOMIC) || '1';
                return `
                    await new Promise(resolve => {
                        log('המתנה של ' + ${secs} + ' שניות...');
                        setTimeout(resolve, ${secs} * 1000);
                    });
                `;
            };

            Blockly.Blocks['control_repeat_times'] = {
                init: function() {
                    this.appendValueInput("TIMES").setCheck("Number").setAlign(Blockly.ALIGN_RIGHT).appendField(new Blockly.FieldImage("https://github.com/codejredu/test/raw/main/assets/blocklyicon/loop.png", 24, 24, "*")).appendField("");
                    this.appendDummyInput().appendField("");
                    this.appendStatementInput("DO").setCheck(null);
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#FF6B1A");
                    this.setTooltip("חזור על הבלוקים שבפנים מספר פעמים.");
                }
            };
            Blockly.JavaScript['control_repeat_times'] = function(block) {
                const times = Blockly.JavaScript.valueToCode(block, 'TIMES', Blockly.JavaScript.ORDER_ATOMIC) || '10';
                const branch = Blockly.JavaScript.statementToCode(block, 'DO');
                return `
                    for (let i = 0; i < ${times}; i++) {
                        log('חזרה מספר: ' + (i + 1));
                        ${branch}
                    }
                `;
            };

            Blockly.Blocks['control_forever'] = {
                init: function() {
                    this.appendDummyInput().appendField(new Blockly.FieldImage("https://github.com/codejredu/test/raw/main/assets/blocklyicon/forever.png", 24, 24, "*")).appendField("");
                    this.appendStatementInput("DO").setCheck(null);
                    this.setPreviousStatement(true, null);
                    this.setColour("#FF6B1A");
                    this.setTooltip("חזור על הבלוקים שבפנים לנצח.");
                }
            };
            Blockly.JavaScript['control_forever'] = function(block) {
                const branch = Blockly.JavaScript.statementToCode(block, 'DO');
                return `
                    while(true) {
                        ${branch}
                        await new Promise(r => setTimeout(r, 10));
                    }
                `;
            };
            Blockly.Blocks['motion_go_to_xy'] = {
                init: function() {
                    this.appendValueInput("X").setCheck("Number").setAlign(Blockly.ALIGN_RIGHT).appendField("X:");
                    this.appendValueInput("Y").setCheck("Number").setAlign(Blockly.ALIGN_RIGHT).appendField("Y:");
                    this.setInputsInline(true);
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#4C97FF");
                    this.setTooltip("הזז את הדמות למיקום ספציפי על הבמה.");
                }
            };
            Blockly.JavaScript['motion_go_to_xy'] = function(block) {
                const x = Blockly.JavaScript.valueToCode(block, 'X', Blockly.JavaScript.ORDER_ATOMIC) || '0';
                const y = Blockly.JavaScript.valueToCode(block, 'Y', Blockly.JavaScript.ORDER_ATOMIC) || '0';
                return `
                    if (activeSprite) {
                        activeSprite.x = parseFloat(${x});
                        activeSprite.y = parseFloat(${y});
                        updateSpritePosition();
                        log('הדמות עברה למיקום: ' + activeSprite.x.toFixed(0) + ', ' + activeSprite.y.toFixed(0));
                    }
                `;
            };
            Blockly.Blocks['motion_glide_to_xy'] = {
                init: function() {
                    this.appendValueInput("SECS").setCheck("Number").setAlign(Blockly.ALIGN_RIGHT).appendField("");
                    this.appendDummyInput().appendField("");
                    this.appendValueInput("X").setCheck("Number").setAlign(Blockly.ALIGN_RIGHT).appendField("X:");
                    this.appendValueInput("Y").setCheck("Number").setAlign(Blockly.ALIGN_RIGHT).appendField("Y:");
                    this.setInputsInline(true);
                    this.setPreviousStatement(true, null);
                    this.setNextStatement(true, null);
                    this.setColour("#4C97FF");
                    this.setTooltip("החלק את הדמות בצורה חלקה למיקום ספציפי.");
                }
            };
            Blockly.JavaScript['motion_glide_to_xy'] = function(block) {
                const secs = Blockly.JavaScript.valueToCode(block, 'SECS', Blockly.JavaScript.ORDER_ATOMIC) || '1';
                const x = Blockly.JavaScript.valueToCode(block, 'X', Blockly.JavaScript.ORDER_ATOMIC) || '0';
                const y = Blockly.JavaScript.valueToCode(block, 'Y', Blockly.JavaScript.ORDER_ATOMIC) || '0';
                return `
                    if (activeSprite) {
                        await new Promise(resolve => {
                            const startX = activeSprite.x;
                            const startY = activeSprite.y;
                            const endX = parseFloat(${x});
                            const endY = parseFloat(${y});
                            const duration = parseFloat(${secs}) * 1000;
                            const startTime = Date.now();
                            
                            const animate = () => {
                                const elapsed = Date.now() - startTime;
                                const progress = Math.min(elapsed / duration, 1);
                                
                                activeSprite.x = startX + (endX - startX) * progress;
                                activeSprite.y = startY + (endY - startY) * progress;
                                
                                updateSpritePosition();
                                
                                if (progress < 1) {
                                    requestAnimationFrame(animate);
                                } else {
                                    log('הדמות סיימה לגלוש.');
                                    resolve();
                                }
                            };
                            animate();
                        });
                    }
                `;
            };

            Blockly.Blocks['operator_add'] = {
                init: function() {
                    this.appendValueInput("NUM1").setCheck("Number");
                    this.appendValueInput("NUM2").setCheck("Number").appendField("+");
                    this.setInputsInline(true);
                    this.setOutput(true, "Number");
                    this.setColour("#40BF4A");
                    this.setTooltip("החזרת סכום שני מספרים.");
                }
            };
            Blockly.JavaScript['operator_add'] = function(block) {
                const num1 = Blockly.JavaScript.valueToCode(block, 'NUM1', Blockly.JavaScript.ORDER_ADDITION) || '0';
                const num2 = Blockly.JavaScript.valueToCode(block, 'NUM2', Blockly.JavaScript.ORDER_ADDITION) || '0';
                const code = `(${num1} + ${num2})`;
                return [code, Blockly.JavaScript.ORDER_ADDITION];
            };

            Blockly.Blocks['operator_subtract'] = {
                init: function() {
                    this.appendValueInput("NUM1").setCheck("Number");
                    this.appendValueInput("NUM2").setCheck("Number").appendField("-");
                    this.setInputsInline(true);
                    this.setOutput(true, "Number");
                    this.setColour("#40BF4A");
                }
            };
            Blockly.JavaScript['operator_subtract'] = function(block) {
                const num1 = Blockly.JavaScript.valueToCode(block, 'NUM1', Blockly.JavaScript.ORDER_SUBTRACTION) || '0';
                const num2 = Blockly.JavaScript.valueToCode(block, 'NUM2', Blockly.JavaScript.ORDER_SUBTRACTION) || '0';
                const code = `(${num1} - ${num2})`;
                return [code, Blockly.JavaScript.ORDER_SUBTRACTION];
            };

            Blockly.Blocks['operator_multiply'] = {
                init: function() {
                    this.appendValueInput("NUM1").setCheck("Number");
                    this.appendValueInput("NUM2").setCheck("Number").appendField("*");
                    this.setInputsInline(true);
                    this.setOutput(true, "Number");
                    this.setColour("#40BF4A");
                    this.setTooltip("החזרת המכפלה של שני מספרים.");
                }
            };
            Blockly.JavaScript['operator_multiply'] = function(block) {
                const num1 = Blockly.JavaScript.valueToCode(block, 'NUM1', Blockly.JavaScript.ORDER_MULTIPLICATION) || '0';
                const num2 = Blockly.JavaScript.valueToCode(block, 'NUM2', Blockly.JavaScript.ORDER_MULTIPLICATION) || '0';
                const code = `(${num1} * ${num2})`;
                return [code, Blockly.JavaScript.ORDER_MULTIPLICATION];
            };

            Blockly.Blocks['operator_divide'] = {
                init: function() {
                    this.appendValueInput("NUM1").setCheck("Number");
                    this.appendValueInput("NUM2").setCheck("Number").appendField("/");
                    this.setInputsInline(true);
                    this.setOutput(true, "Number");
                    this.setColour("#40BF4A");
                    this.setTooltip("החזרת תוצאת החילוק של שני מספרים.");
                }
            };
            Blockly.JavaScript['operator_divide'] = function(block) {
                const num1 = Blockly.JavaScript.valueToCode(block, 'NUM1', Blockly.JavaScript.ORDER_DIVISION) || '0';
                const num2 = Blockly.JavaScript.valueToCode(block, 'NUM2', Blockly.JavaScript.ORDER_DIVISION) || '1';
                const code = `(${num1} / ${num2})`;
                return [code, Blockly.JavaScript.ORDER_DIVISION];
            };

            Blockly.Blocks['operator_random_number'] = {
                init: function() {
                    this.appendDummyInput().appendField("");
                    this.appendDummyInput().appendField(new Blockly.FieldNumber(1), "FROM");
                    this.appendDummyInput().appendField("-");
                    this.appendDummyInput().appendField(new Blockly.FieldNumber(10), "TO");
                    this.setInputsInline(true);
                    this.setOutput(true, "Number");
                    this.setColour("#40BF4A");
                    this.setTooltip("החזרת מספר שלם אקראי בין שני מספרים.");
                }
            };
            Blockly.JavaScript['operator_random_number'] = function(block) {
                const from = block.getFieldValue('FROM');
                const to = block.getFieldValue('TO');
                const code = `Math.floor(Math.random() * (${to} - ${from} + 1)) + ${from}`;
                return [code, Blockly.JavaScript.ORDER_FUNCTION_CALL];
            };
            
            // Configure Blockly's angle picker to match Scratch
            // 0 is up, clockwise
            Blockly.FieldAngle.OFFSET = 90;
            Blockly.FieldAngle.CLOCKWISE = true;
            
            workspace = Blockly.inject('blockly-area', {
                toolbox: document.getElementById('toolbox'),
                rtl: true,
                zoom: {
                    controls: true,
                    wheel: true,
                    startScale: 1.0,
                    maxScale: 3,
                    minScale: 0.3,
                    scaleSpeed: 1.2
                }
            });

            async function executeBlock(blockId) {
                const block = workspace.getBlockById(blockId);
                if (!block || block.type.startsWith('event_')) return;
                
                log(`מפעיל בלוק בודד: ${block.type}`);
                
                const code = Blockly.JavaScript.blockToCode(block);
                if (code) {
                    try {
                        const AsyncFunction = Object.getPrototypeOf(async function(){}).constructor;
                        const f = new AsyncFunction('activeSprite', 'updateSpritePosition', 'log', 'STAGE_WIDTH', 'STAGE_HEIGHT', code);
                        await f(activeSprite, updateSpritePosition, log, STAGE_WIDTH, STAGE_HEIGHT);
                    } catch (e) {
                        log('שגיאת ריצה: ' + e);
                    }
                }
            }
            
            // שינוי האזנה: לכידת אירוע לחיצה על האובייקט SVG של הבלוק
            const blocklyDiv = document.getElementById('blockly-area');
            blocklyDiv.addEventListener('click', (event) => {
                const blocklyBlockSvg = event.target.closest('.blocklyDraggable');
                if (blocklyBlockSvg) {
                    const blockId = blocklyBlockSvg.getAttribute('data-id');
                    if (blockId) {
                        executeBlock(blockId);
                    }
                }
            });

            document.getElementById('run-button').addEventListener('click', runCode);
            document.getElementById('reset-button').addEventListener('click', reset);

            async function runCode() {
                if (!activeSprite) {
                    log('אין דמות פעילה, בחר דמות לפני הפעלת קוד.');
                    return;
                }
                log('התסריט הופעל.');
                const code = Blockly.JavaScript.workspaceToCode(workspace);
                try {
                    const AsyncFunction = Object.getPrototypeOf(async function(){}).constructor;
                    const f = new AsyncFunction('activeSprite', 'updateSpritePosition', 'log', 'STAGE_WIDTH', 'STAGE_HEIGHT', code);
                    await f(activeSprite, updateSpritePosition, log, STAGE_WIDTH, STAGE_HEIGHT);
                } catch (e) {
                    log('שגיאת ריצה: ' + e);
                }
            }

            function reset() {
                if (activeSprite) {
                    activeSprite.x = 0;
                    activeSprite.y = 0;
                    activeSprite.direction = 90;
                    updateSpritePosition();
                    log('הבמה אופסה.');
                }
            }
            
            function createDefaultBackdrop() {
                const defaultBackdrop = document.createElement('div');
                defaultBackdrop.classList.add('backdrop-card');
                defaultBackdrop.style.backgroundImage = 'url("https://codejredu.github.io/test/assets/bg/space1.svg")';
                defaultBackdrop.dataset.url = "https://codejredu.github.io/test/assets/bg/space1.svg";
                defaultBackdrop.classList.add('selected');
                backdropsList.appendChild(defaultBackdrop);
                document.getElementById('stage-area').style.backgroundImage = `url("https://codejredu.github.io/test/assets/bg/space1.svg")`;
            }

            function createDefaultSprite() {
                const defaultSprite = createNewSprite('חתול', 'https://codejredu.github.io/claudejr/GingerCat.svg', 0, 0);
                updateSpritePosition();
            }

            function handleBackdropSelection(e) {
                const url = e.target.dataset.url;
                if (url) {
                    document.getElementById('stage-area').style.backgroundImage = `url("${url}")`;
                    document.querySelectorAll('.backdrop-card').forEach(card => card.classList.remove('selected'));
                    e.target.classList.add('selected');
                }
            }

            function handleGallerySelection(e) {
                const url = e.target.src;
                if (url) {
                    document.getElementById('stage-area').style.backgroundImage = `url("${url}")`;
                    
                    const newBackdropCard = document.createElement('div');
                    newBackdropCard.classList.add('backdrop-card');
                    newBackdropCard.style.backgroundImage = `url("${url}")`;
                    newBackdropCard.dataset.url = url;
                    
                    document.querySelectorAll('.backdrop-card').forEach(card => card.classList.remove('selected'));
                    
                    newBackdropCard.classList.add('selected');
                    backdropsList.appendChild(newBackdropCard);

                    backgroundGallery.classList.remove('visible');
                }
            }

            function handleSpriteGallerySelection(e) {
                const target = e.target;
                if (target.tagName === 'IMG' && target.classList.contains('thumbnail')) {
                    const url = target.src;
                    const name = target.alt || 'דמות חדשה';
                    createNewSprite(name, url, 0, 0);
                    spriteGallery.classList.remove('visible');
                }
            }

            createDefaultBackdrop();
            createDefaultSprite();

            backdropsList.addEventListener('click', handleBackdropSelection);
            
            addBackdropButton.addEventListener('click', () => {
                backgroundGallery.classList.add('visible');
            });
            
            closeGalleryButton.addEventListener('click', (e) => {
                e.stopPropagation();
                backgroundGallery.classList.remove('visible');
            });
            
            thumbnailsGrid.addEventListener('click', handleGallerySelection);
            
            addSpriteButton.addEventListener('click', () => {
                spriteGallery.classList.add('visible');
            });

            closeSpriteGalleryButton.addEventListener('click', (e) => {
                e.stopPropagation();
                spriteGallery.classList.remove('visible');
            });

            spriteThumbnailsGrid.addEventListener('click', handleSpriteGallerySelection);
        });
    </script>
</body>
</html>

